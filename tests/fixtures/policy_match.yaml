# Test suite for policy matching
# Tests matching connection log events against policy rules
#
# Each test case has:
#   - name: Test description
#   - policy: Policy text
#   - connections: List of connection events to test
#     - event: Connection log event (matching proxy log format)
#     - verdict: "allow" | "block"
#     - match: (optional) Index of matching rule (for debugging), null if blocked
#
# Connection event format (from proxy logging):
#   - type: "http" | "https" | "tcp" | "dns" | "udp"
#   - dst_ip: Destination IP address
#   - dst_port: Destination port
#   - url: Full URL (for http type)
#   - host: SNI hostname (for https type)
#   - name: DNS query name (for dns type)
#   - exe: Executable path
#   - cmdline: List of command arguments
#   - cgroup: Cgroup path
#   - step: GitHub Actions step

tests:
  # =============================================================================
  # Basic hostname matching
  # =============================================================================

  - name: Exact hostname match
    policy: |
      github.com
    connections:
      - event:
          type: https
          dst_ip: 140.82.121.4
          dst_port: 443
          host: github.com
        verdict: allow
      - event:
          type: https
          dst_ip: 140.82.121.4
          dst_port: 443
          host: api.github.com
        verdict: block
      - event:
          type: https
          dst_ip: 140.82.121.4
          dst_port: 443
          host: www.github.com
        verdict: block

  - name: Wildcard hostname match
    policy: |
      *.github.com
    connections:
      - event:
          type: https
          dst_ip: 140.82.121.4
          dst_port: 443
          host: api.github.com
        verdict: allow
      - event:
          type: https
          dst_ip: 140.82.121.4
          dst_port: 443
          host: www.github.com
        verdict: allow
      - event:
          type: https
          dst_ip: 140.82.121.4
          dst_port: 443
          host: deep.nested.github.com
        verdict: allow
      - event:
          type: https
          dst_ip: 140.82.121.4
          dst_port: 443
          host: github.com
        verdict: block

  - name: Hostname case insensitive
    policy: |
      GitHub.COM
    connections:
      - event:
          type: https
          dst_ip: 140.82.121.4
          dst_port: 443
          host: github.com
        verdict: allow
      - event:
          type: https
          dst_ip: 140.82.121.4
          dst_port: 443
          host: GITHUB.COM
        verdict: allow

  - name: Label wildcard match (fnmatch in first label)
    policy: |
      derp*.tailscale.com
    connections:
      - event:
          type: https
          dst_ip: 1.2.3.4
          dst_port: 443
          host: derp1.tailscale.com
        verdict: allow
      - event:
          type: https
          dst_ip: 1.2.3.4
          dst_port: 443
          host: derp2f.tailscale.com
        verdict: allow
      - event:
          type: https
          dst_ip: 1.2.3.4
          dst_port: 443
          host: derp.tailscale.com
        verdict: allow
      # Does not match with extra subdomains
      - event:
          type: https
          dst_ip: 1.2.3.4
          dst_port: 443
          host: foo.derp1.tailscale.com
        verdict: block
      # Does not match base domain
      - event:
          type: https
          dst_ip: 1.2.3.4
          dst_port: 443
          host: tailscale.com
        verdict: block
      # Does not match wrong prefix
      - event:
          type: https
          dst_ip: 1.2.3.4
          dst_port: 443
          host: api.tailscale.com
        verdict: block

  - name: Subdomain + label wildcard match
    policy: |
      *.derp*.tailscale.com
    connections:
      # Matches with extra subdomain
      - event:
          type: https
          dst_ip: 1.2.3.4
          dst_port: 443
          host: foo.derp1.tailscale.com
        verdict: allow
      - event:
          type: https
          dst_ip: 1.2.3.4
          dst_port: 443
          host: a.b.derp2.tailscale.com
        verdict: allow
      # Does not match without extra subdomain
      - event:
          type: https
          dst_ip: 1.2.3.4
          dst_port: 443
          host: derp1.tailscale.com
        verdict: block
      # Does not match wrong label
      - event:
          type: https
          dst_ip: 1.2.3.4
          dst_port: 443
          host: foo.api.tailscale.com
        verdict: block

  - name: Suffix wildcard pattern
    policy: |
      *-prod.example.com
    connections:
      - event:
          type: https
          dst_ip: 1.2.3.4
          dst_port: 443
          host: api-prod.example.com
        verdict: allow
      - event:
          type: https
          dst_ip: 1.2.3.4
          dst_port: 443
          host: web-prod.example.com
        verdict: allow
      - event:
          type: https
          dst_ip: 1.2.3.4
          dst_port: 443
          host: api-dev.example.com
        verdict: block

  # =============================================================================
  # IP and CIDR matching
  # =============================================================================

  - name: Exact IP match
    policy: |
      8.8.8.8:53/udp
    connections:
      - event:
          type: udp
          dst_ip: 8.8.8.8
          dst_port: 53
        verdict: allow
      - event:
          type: udp
          dst_ip: 8.8.4.4
          dst_port: 53
        verdict: block

  - name: CIDR block match
    policy: |
      10.0.0.0/8:*
    connections:
      - event:
          type: tcp
          dst_ip: 10.0.0.1
          dst_port: 80
        verdict: allow
      - event:
          type: tcp
          dst_ip: 10.255.255.255
          dst_port: 443
        verdict: allow
      - event:
          type: tcp
          dst_ip: 10.1.2.3
          dst_port: 8080
        verdict: allow
      - event:
          type: tcp
          dst_ip: 192.168.1.1
          dst_port: 80
        verdict: block

  - name: CIDR /24 block
    policy: |
      192.168.1.0/24:*
    connections:
      - event:
          type: tcp
          dst_ip: 192.168.1.1
          dst_port: 80
        verdict: allow
      - event:
          type: tcp
          dst_ip: 192.168.1.254
          dst_port: 443
        verdict: allow
      - event:
          type: tcp
          dst_ip: 192.168.2.1
          dst_port: 80
        verdict: block

  # =============================================================================
  # Port matching
  # =============================================================================

  - name: Default port 443
    policy: |
      github.com
    connections:
      - event:
          type: https
          dst_ip: 140.82.121.4
          dst_port: 443
          host: github.com
        verdict: allow
      - event:
          type: tcp
          dst_ip: 140.82.121.4
          dst_port: 22
        verdict: block

  - name: Explicit port
    policy: |
      github.com:22
    connections:
      - event:
          type: tcp
          dst_ip: 140.82.121.4
          dst_port: 22
          host: github.com
        verdict: allow
      - event:
          type: https
          dst_ip: 140.82.121.4
          dst_port: 443
          host: github.com
        verdict: block

  - name: Multiple ports
    policy: |
      example.com:80|443
    connections:
      - event:
          type: http
          dst_ip: 93.184.216.34
          dst_port: 80
          url: http://example.com/
        verdict: allow
      - event:
          type: https
          dst_ip: 93.184.216.34
          dst_port: 443
          host: example.com
        verdict: allow
      - event:
          type: tcp
          dst_ip: 93.184.216.34
          dst_port: 8080
        verdict: block

  - name: Any port wildcard
    policy: |
      github.com:*
    connections:
      - event:
          type: https
          dst_ip: 140.82.121.4
          dst_port: 443
          host: github.com
        verdict: allow
      - event:
          type: tcp
          dst_ip: 140.82.121.4
          dst_port: 22
          host: github.com
        verdict: allow
      - event:
          type: tcp
          dst_ip: 140.82.121.4
          dst_port: 9418
          host: github.com
        verdict: allow

  # =============================================================================
  # Protocol matching
  # =============================================================================

  - name: UDP protocol
    policy: |
      8.8.8.8:53/udp
    connections:
      - event:
          type: udp
          dst_ip: 8.8.8.8
          dst_port: 53
        verdict: allow
      # DNS requires both resolver AND domain - domain not allowed here
      - event:
          type: dns
          dst_ip: 8.8.8.8
          dst_port: 53
          name: example.com
        verdict: block
      - event:
          type: tcp
          dst_ip: 8.8.8.8
          dst_port: 53
        verdict: block

  - name: TCP protocol (default)
    policy: |
      github.com:443
    connections:
      - event:
          type: https
          dst_ip: 140.82.121.4
          dst_port: 443
          host: github.com
        verdict: allow
      - event:
          type: tcp
          dst_ip: 140.82.121.4
          dst_port: 443
          host: github.com
        verdict: allow

  # =============================================================================
  # URL path matching
  # =============================================================================

  - name: URL with exact path
    policy: |
      https://api.github.com/repos
    connections:
      - event:
          type: http
          dst_ip: 140.82.121.4
          dst_port: 443
          url: https://api.github.com/repos
        verdict: allow
      - event:
          type: http
          dst_ip: 140.82.121.4
          dst_port: 443
          url: https://api.github.com/repos/owner/repo
        verdict: block

  - name: URL with trailing wildcard (greedy)
    policy: |
      https://github.com/*
    connections:
      - event:
          type: http
          dst_ip: 140.82.121.4
          dst_port: 443
          url: https://github.com/owner
        verdict: allow
      - event:
          type: http
          dst_ip: 140.82.121.4
          dst_port: 443
          url: https://github.com/owner/repo/releases
        verdict: allow
      - event:
          type: http
          dst_ip: 140.82.121.4
          dst_port: 443
          url: https://github.com/
        verdict: allow

  - name: URL with segment wildcard
    policy: |
      https://api.github.com/repos/*/releases
    connections:
      - event:
          type: http
          dst_ip: 140.82.121.4
          dst_port: 443
          url: https://api.github.com/repos/owner/releases
        verdict: allow
      - event:
          type: http
          dst_ip: 140.82.121.4
          dst_port: 443
          url: https://api.github.com/repos/other-owner/releases
        verdict: allow
      - event:
          type: http
          dst_ip: 140.82.121.4
          dst_port: 443
          url: https://api.github.com/repos/owner/repo/releases
        verdict: block

  - name: URL with multiple segment wildcards
    policy: |
      https://api.github.com/repos/*/*/releases
    connections:
      - event:
          type: http
          dst_ip: 140.82.121.4
          dst_port: 443
          url: https://api.github.com/repos/owner/repo/releases
        verdict: allow
      - event:
          type: http
          dst_ip: 140.82.121.4
          dst_port: 443
          url: https://api.github.com/repos/a/b/releases
        verdict: allow
      - event:
          type: http
          dst_ip: 140.82.121.4
          dst_port: 443
          url: https://api.github.com/repos/owner/releases
        verdict: block

  - name: URL with partial segment wildcard
    policy: |
      https://cdn.example.com/v*.zip
    connections:
      - event:
          type: http
          dst_ip: 93.184.216.34
          dst_port: 443
          url: https://cdn.example.com/v1.0.0.zip
        verdict: allow
      - event:
          type: http
          dst_ip: 93.184.216.34
          dst_port: 443
          url: https://cdn.example.com/v2.zip
        verdict: allow
      - event:
          type: http
          dst_ip: 93.184.216.34
          dst_port: 443
          url: https://cdn.example.com/release.zip
        verdict: block

  - name: URL path is case sensitive
    policy: |
      https://api.github.com/Repos/*
    connections:
      - event:
          type: http
          dst_ip: 140.82.121.4
          dst_port: 443
          url: https://api.github.com/Repos/owner
        verdict: allow
      - event:
          type: http
          dst_ip: 140.82.121.4
          dst_port: 443
          url: https://api.github.com/repos/owner
        verdict: block

  # =============================================================================
  # URL rules with IP addresses
  # =============================================================================

  - name: URL with IP address matches HTTP request to IP
    policy: |
      http://168.63.129.16/*
    connections:
      - event:
          type: http
          dst_ip: 168.63.129.16
          dst_port: 80
          url: http://168.63.129.16/machine
        verdict: allow
      - event:
          type: http
          dst_ip: 168.63.129.16
          dst_port: 80
          url: http://168.63.129.16/health
        verdict: allow
      # Different IP - should not match
      - event:
          type: http
          dst_ip: 10.0.0.1
          dst_port: 80
          url: http://10.0.0.1/machine
        verdict: block

  - name: URL with IP address does NOT match hostname-based request
    policy: |
      http://168.63.129.16/*
    connections:
      # Even if example.com resolves to 168.63.129.16, URL matching is string-based
      - event:
          type: http
          dst_ip: 168.63.129.16
          dst_port: 80
          url: http://example.com/api
        verdict: block

  - name: URL with IP address and explicit port
    policy: |
      http://168.63.129.16:32526/*
    connections:
      - event:
          type: http
          dst_ip: 168.63.129.16
          dst_port: 32526
          url: http://168.63.129.16:32526/health
        verdict: allow
      # Wrong port in URL - should not match
      - event:
          type: http
          dst_ip: 168.63.129.16
          dst_port: 80
          url: http://168.63.129.16/health
        verdict: block

  - name: URL with IP address and method restriction
    policy: |
      POST http://192.168.1.1/api/submit
    connections:
      - event:
          type: http
          dst_ip: 192.168.1.1
          dst_port: 80
          url: http://192.168.1.1/api/submit
          method: POST
        verdict: allow
      - event:
          type: http
          dst_ip: 192.168.1.1
          dst_port: 80
          url: http://192.168.1.1/api/submit
          method: GET
        verdict: block

  - name: URL with IP address and any method
    policy: |
      * http://10.0.0.1/api/*
    connections:
      - event:
          type: http
          dst_ip: 10.0.0.1
          dst_port: 80
          url: http://10.0.0.1/api/users
          method: GET
        verdict: allow
      - event:
          type: http
          dst_ip: 10.0.0.1
          dst_port: 80
          url: http://10.0.0.1/api/users
          method: POST
        verdict: allow
      - event:
          type: http
          dst_ip: 10.0.0.1
          dst_port: 80
          url: http://10.0.0.1/api/users
          method: DELETE
        verdict: allow

  - name: IP address network rule still matches HTTP at TCP level
    policy: |
      168.63.129.16:80
    connections:
      # Network rules match based on IP/port, regardless of URL content
      - event:
          type: http
          dst_ip: 168.63.129.16
          dst_port: 80
          url: http://168.63.129.16/anything
        verdict: allow
      - event:
          type: http
          dst_ip: 168.63.129.16
          dst_port: 80
          url: http://example.com/anything
        verdict: allow

  # =============================================================================
  # IP vs hostname URL matching - safeguards against crossover
  # =============================================================================

  - name: Hostname URL rule does NOT match IP-based request (even same IP)
    policy: |
      http://example.com/*
    connections:
      # Hostname-based rule should not match request with IP in URL
      # even if the IP is what example.com resolves to
      - event:
          type: http
          dst_ip: 93.184.216.34
          dst_port: 80
          url: http://93.184.216.34/path
        verdict: block
      # But should match hostname-based request
      - event:
          type: http
          dst_ip: 93.184.216.34
          dst_port: 80
          url: http://example.com/path
        verdict: allow

  - name: IP URL rule does NOT match hostname-based request (strict string match)
    policy: |
      http://93.184.216.34/*
    connections:
      # IP-based rule should not match request with hostname in URL
      - event:
          type: http
          dst_ip: 93.184.216.34
          dst_port: 80
          url: http://example.com/path
        verdict: block
      # But should match IP-based request
      - event:
          type: http
          dst_ip: 93.184.216.34
          dst_port: 80
          url: http://93.184.216.34/path
        verdict: allow

  - name: Mixed policy with both IP and hostname rules
    policy: |
      http://168.63.129.16/*
      http://example.com/*
    connections:
      # IP rule matches IP request
      - event:
          type: http
          dst_ip: 168.63.129.16
          dst_port: 80
          url: http://168.63.129.16/api
        verdict: allow
      # Hostname rule matches hostname request
      - event:
          type: http
          dst_ip: 93.184.216.34
          dst_port: 80
          url: http://example.com/api
        verdict: allow
      # No crossover - hostname request to IP address
      - event:
          type: http
          dst_ip: 168.63.129.16
          dst_port: 80
          url: http://wireserver.local/api
        verdict: block
      # No crossover - IP request when only hostname rule exists
      - event:
          type: http
          dst_ip: 93.184.216.34
          dst_port: 80
          url: http://93.184.216.34/api
        verdict: block

  # =============================================================================
  # HTTP method matching
  # =============================================================================

  - name: GET method only (default for URLs)
    policy: |
      https://api.github.com/*
    connections:
      - event:
          type: http
          dst_ip: 140.82.121.4
          dst_port: 443
          url: https://api.github.com/repos
          method: GET
        verdict: allow
      - event:
          type: http
          dst_ip: 140.82.121.4
          dst_port: 443
          url: https://api.github.com/repos
          method: HEAD
        verdict: allow
      - event:
          type: http
          dst_ip: 140.82.121.4
          dst_port: 443
          url: https://api.github.com/repos
          method: POST
        verdict: block

  - name: Explicit POST method
    policy: |
      POST https://api.github.com/repos/*/issues
    connections:
      - event:
          type: http
          dst_ip: 140.82.121.4
          dst_port: 443
          url: https://api.github.com/repos/owner/issues
          method: POST
        verdict: allow
      - event:
          type: http
          dst_ip: 140.82.121.4
          dst_port: 443
          url: https://api.github.com/repos/owner/issues
          method: GET
        verdict: block

  - name: Multiple methods
    policy: |
      GET|POST|PUT https://api.example.com/*
    connections:
      - event:
          type: http
          dst_ip: 93.184.216.34
          dst_port: 443
          url: https://api.example.com/data
          method: GET
        verdict: allow
      - event:
          type: http
          dst_ip: 93.184.216.34
          dst_port: 443
          url: https://api.example.com/data
          method: POST
        verdict: allow
      - event:
          type: http
          dst_ip: 93.184.216.34
          dst_port: 443
          url: https://api.example.com/data
          method: PUT
        verdict: allow
      - event:
          type: http
          dst_ip: 93.184.216.34
          dst_port: 443
          url: https://api.example.com/data
          method: DELETE
        verdict: block

  - name: Any method wildcard
    policy: |
      * https://api.github.com/*
    connections:
      - event:
          type: http
          dst_ip: 140.82.121.4
          dst_port: 443
          url: https://api.github.com/repos
          method: POST
        verdict: allow
      - event:
          type: http
          dst_ip: 140.82.121.4
          dst_port: 443
          url: https://api.github.com/repos
          method: DELETE
        verdict: allow

  # =============================================================================
  # Path rules with URL base
  # =============================================================================

  - name: Path rule with URL base header
    policy: |
      [https://api.github.com]
      GET /repos/*/releases
      POST /repos/*/issues
    connections:
      - event:
          type: http
          dst_ip: 140.82.121.4
          dst_port: 443
          url: https://api.github.com/repos/owner/releases
          method: GET
        verdict: allow
      - event:
          type: http
          dst_ip: 140.82.121.4
          dst_port: 443
          url: https://api.github.com/repos/owner/issues
          method: POST
        verdict: allow
      - event:
          type: http
          dst_ip: 140.82.121.4
          dst_port: 443
          url: https://api.github.com/repos/owner/issues
          method: GET
        verdict: block
      - event:
          type: http
          dst_ip: 140.82.121.4
          dst_port: 443
          url: https://github.com/repos/owner/releases
          method: GET
        verdict: block

  - name: Path rule with URL base path prefix
    policy: |
      [https://api.github.com/v1]
      /repos/*
    connections:
      - event:
          type: http
          dst_ip: 140.82.121.4
          dst_port: 443
          url: https://api.github.com/v1/repos/anything
          method: GET
        verdict: allow
      - event:
          type: http
          dst_ip: 140.82.121.4
          dst_port: 443
          url: https://api.github.com/repos/anything
          method: GET
        verdict: block

  # =============================================================================
  # Process attributes
  # =============================================================================

  - name: Exe attribute exact match
    policy: |
      github.com exe=/usr/bin/curl
    connections:
      - event:
          type: https
          dst_ip: 140.82.121.4
          dst_port: 443
          host: github.com
          exe: /usr/bin/curl
        verdict: allow
      - event:
          type: https
          dst_ip: 140.82.121.4
          dst_port: 443
          host: github.com
          exe: /usr/bin/wget
        verdict: block

  - name: Exe attribute with wildcard
    policy: |
      github.com exe=*/node
    connections:
      - event:
          type: https
          dst_ip: 140.82.121.4
          dst_port: 443
          host: github.com
          exe: /usr/bin/node
        verdict: allow
      - event:
          type: https
          dst_ip: 140.82.121.4
          dst_port: 443
          host: github.com
          exe: /home/user/.nvm/versions/node/v18/bin/node
        verdict: allow
      - event:
          type: https
          dst_ip: 140.82.121.4
          dst_port: 443
          host: github.com
          exe: /usr/bin/python
        verdict: block

  - name: Arg attribute matches any argument
    policy: |
      github.com arg=--upload
    connections:
      - event:
          type: https
          dst_ip: 140.82.121.4
          dst_port: 443
          host: github.com
          cmdline: ["curl", "--upload", "file.txt"]
        verdict: allow
      - event:
          type: https
          dst_ip: 140.82.121.4
          dst_port: 443
          host: github.com
          cmdline: ["curl", "-X", "POST", "--upload", "file.txt"]
        verdict: allow
      - event:
          type: https
          dst_ip: 140.82.121.4
          dst_port: 443
          host: github.com
          cmdline: ["curl", "-X", "GET"]
        verdict: block

  - name: Indexed arg attribute
    policy: |
      github.com arg[0]=node
    connections:
      - event:
          type: https
          dst_ip: 140.82.121.4
          dst_port: 443
          host: github.com
          cmdline: ["node", "script.js"]
        verdict: allow
      - event:
          type: https
          dst_ip: 140.82.121.4
          dst_port: 443
          host: github.com
          cmdline: ["python", "script.py"]
        verdict: block

  - name: Multiple indexed args
    policy: |
      github.com arg[0]=npm arg[1]=publish
    connections:
      - event:
          type: https
          dst_ip: 140.82.121.4
          dst_port: 443
          host: github.com
          cmdline: ["npm", "publish", "--access=public"]
        verdict: allow
      - event:
          type: https
          dst_ip: 140.82.121.4
          dst_port: 443
          host: github.com
          cmdline: ["npm", "install"]
        verdict: block

  - name: Step attribute
    policy: |
      github.com step=build.my-step
    connections:
      - event:
          type: https
          dst_ip: 140.82.121.4
          dst_port: 443
          host: github.com
          step: build.my-step
        verdict: allow
      - event:
          type: https
          dst_ip: 140.82.121.4
          dst_port: 443
          host: github.com
          step: build.other-step
        verdict: block
      - event:
          type: https
          dst_ip: 140.82.121.4
          dst_port: 443
          host: github.com
        verdict: block

  - name: Action attribute exact match
    policy: |
      github.com action=actions/checkout
    connections:
      - event:
          type: https
          dst_ip: 140.82.121.4
          dst_port: 443
          host: github.com
          action: actions/checkout
        verdict: allow
      - event:
          type: https
          dst_ip: 140.82.121.4
          dst_port: 443
          host: github.com
          action: actions/setup-node
        verdict: block
      - event:
          type: https
          dst_ip: 140.82.121.4
          dst_port: 443
          host: github.com
        verdict: block

  - name: Action attribute wildcard match
    policy: |
      github.com action=actions/*
    connections:
      - event:
          type: https
          dst_ip: 140.82.121.4
          dst_port: 443
          host: github.com
          action: actions/checkout
        verdict: allow
      - event:
          type: https
          dst_ip: 140.82.121.4
          dst_port: 443
          host: github.com
          action: actions/setup-node
        verdict: allow
      - event:
          type: https
          dst_ip: 140.82.121.4
          dst_port: 443
          host: github.com
          action: docker/build-push-action
        verdict: block

  - name: Cgroup attribute with abstraction
    policy: |
      github.com cgroup=@docker
    connections:
      - event:
          type: https
          dst_ip: 140.82.121.4
          dst_port: 443
          host: github.com
          cgroup: /docker/abc123
        verdict: allow
      - event:
          type: https
          dst_ip: 140.82.121.4
          dst_port: 443
          host: github.com
          cgroup: /system.slice/docker-abc123.scope
        verdict: allow
      - event:
          type: https
          dst_ip: 140.82.121.4
          dst_port: 443
          host: github.com
          cgroup: /user.slice/user-1000.slice
        verdict: block

  # =============================================================================
  # Headers and context inheritance
  # =============================================================================

  - name: Header port inheritance
    policy: |
      [:22]
      github.com
      gitlab.com
    connections:
      - event:
          type: tcp
          dst_ip: 140.82.121.4
          dst_port: 22
          host: github.com
        verdict: allow
      - event:
          type: https
          dst_ip: 140.82.121.4
          dst_port: 443
          host: github.com
        verdict: block

  - name: Header reset to defaults
    policy: |
      [:22]
      github.com
      []
      gitlab.com
    connections:
      - event:
          type: tcp
          dst_ip: 140.82.121.4
          dst_port: 22
          host: github.com
        verdict: allow
      - event:
          type: https
          dst_ip: 172.65.251.78
          dst_port: 443
          host: gitlab.com
        verdict: allow
      - event:
          type: tcp
          dst_ip: 172.65.251.78
          dst_port: 22
          host: gitlab.com
        verdict: block

  # =============================================================================
  # Union semantics (any rule match = allow)
  # =============================================================================

  - name: Multiple rules - any match allows
    policy: |
      github.com:443
      github.com:22
      *.github.com
    connections:
      - event:
          type: https
          dst_ip: 140.82.121.4
          dst_port: 443
          host: github.com
        verdict: allow
      - event:
          type: tcp
          dst_ip: 140.82.121.4
          dst_port: 22
          host: github.com
        verdict: allow
      - event:
          type: https
          dst_ip: 140.82.121.4
          dst_port: 443
          host: api.github.com
        verdict: allow

  # =============================================================================
  # DNS matching
  # =============================================================================
  # DNS requires BOTH resolver AND domain to be allowed:
  # 1. Resolver: IP/CIDR rule with :53/udp matching the DNS server
  # 2. Domain: hostname/URL rule matching the queried domain

  - name: DNS requires both resolver and domain allowed
    policy: |
      # Resolver
      8.8.8.8:53/udp
      # Domain
      *.example.com
    connections:
      # Both resolver and domain allowed - passes
      - event:
          type: dns
          dst_ip: 8.8.8.8
          dst_port: 53
          name: api.example.com
        verdict: allow
      # Resolver allowed but domain not - blocked
      - event:
          type: dns
          dst_ip: 8.8.8.8
          dst_port: 53
          name: other.com
        verdict: block
      # Domain allowed but resolver not - blocked
      - event:
          type: dns
          dst_ip: 1.1.1.1
          dst_port: 53
          name: api.example.com
        verdict: block

  - name: DNS resolver only does not allow arbitrary domains
    policy: |
      8.8.8.8:53/udp
    connections:
      # No domain rules - all DNS blocked even to allowed resolver
      - event:
          type: dns
          dst_ip: 8.8.8.8
          dst_port: 53
          name: anything.com
        verdict: block
      - event:
          type: dns
          dst_ip: 8.8.8.8
          dst_port: 53
          name: evil.com
        verdict: block

  - name: DNS domain only does not allow arbitrary resolvers
    policy: |
      github.com
    connections:
      # No resolver rules - DNS blocked even for allowed domain
      - event:
          type: dns
          dst_ip: 8.8.8.8
          dst_port: 53
          name: github.com
        verdict: block

  - name: DNS with multiple resolvers and domains
    policy: |
      # Resolvers
      8.8.8.8:53/udp
      1.1.1.1:53/udp
      # Domains
      *.github.com
      github.com
      example.com
    connections:
      # Github on Google DNS - allowed
      - event:
          type: dns
          dst_ip: 8.8.8.8
          dst_port: 53
          name: api.github.com
        verdict: allow
      # Github on Cloudflare DNS - allowed
      - event:
          type: dns
          dst_ip: 1.1.1.1
          dst_port: 53
          name: github.com
        verdict: allow
      # Evil domain on allowed resolver - blocked (domain not allowed)
      - event:
          type: dns
          dst_ip: 8.8.8.8
          dst_port: 53
          name: evil.com
        verdict: block
      # Allowed domain on disallowed resolver - blocked
      - event:
          type: dns
          dst_ip: 9.9.9.9
          dst_port: 53
          name: github.com
        verdict: block

  # =============================================================================
  # Edge cases
  # =============================================================================

  - name: Connection without hostname uses IP matching
    policy: |
      140.82.121.4:443
    connections:
      - event:
          type: tcp
          dst_ip: 140.82.121.4
          dst_port: 443
        verdict: allow
      - event:
          type: https
          dst_ip: 140.82.121.4
          dst_port: 443
          host: github.com
        verdict: allow

  - name: Missing process info blocks when attribute required
    policy: |
      github.com exe=/usr/bin/curl
    connections:
      - event:
          type: https
          dst_ip: 140.82.121.4
          dst_port: 443
          host: github.com
        verdict: block

  - name: Empty policy blocks everything
    policy: ""
    connections:
      - event:
          type: https
          dst_ip: 140.82.121.4
          dst_port: 443
          host: github.com
        verdict: block
      - event:
          type: tcp
          dst_ip: 8.8.8.8
          dst_port: 53
        verdict: block

  # =============================================================================
  # Complex realistic scenario
  # =============================================================================

  - name: Complex realistic policy
    policy: |
      # Package registries
      registry.npmjs.org
      *.npmjs.org

      # GitHub API with restrictions
      [https://api.github.com]
      GET /repos/*/releases
      POST /repos/*/issues exe=*/node

      # DNS resolvers
      [:53/udp]
      8.8.8.8
      1.1.1.1

      # Internal network
      [:*]
      10.0.0.0/8
    connections:
      - event:
          type: https
          dst_ip: 104.16.0.0
          dst_port: 443
          host: registry.npmjs.org
        verdict: allow
      - event:
          type: https
          dst_ip: 104.16.0.0
          dst_port: 443
          host: cdn.npmjs.org
        verdict: allow
      - event:
          type: http
          dst_ip: 140.82.121.4
          dst_port: 443
          url: https://api.github.com/repos/owner/releases
          method: GET
        verdict: allow
      - event:
          type: http
          dst_ip: 140.82.121.4
          dst_port: 443
          url: https://api.github.com/repos/owner/issues
          method: POST
          exe: /usr/bin/node
        verdict: allow
      - event:
          type: http
          dst_ip: 140.82.121.4
          dst_port: 443
          url: https://api.github.com/repos/owner/issues
          method: POST
          exe: /usr/bin/curl
        verdict: block
      # DNS requires both resolver AND domain - npmjs.org is allowed
      - event:
          type: dns
          dst_ip: 8.8.8.8
          dst_port: 53
          name: registry.npmjs.org
        verdict: allow
      - event:
          type: udp
          dst_ip: 1.1.1.1
          dst_port: 53
        verdict: allow
      - event:
          type: tcp
          dst_ip: 10.1.2.3
          dst_port: 8080
        verdict: allow
      - event:
          type: https
          dst_ip: 93.184.216.34
          dst_port: 443
          host: example.com
        verdict: block

  # =============================================================================
  # DNS-only rules (dns: prefix)
  # =============================================================================

  - name: DNS-only rule allows DNS resolution
    policy: |
      8.8.8.8:53/udp
      dns:example.com
    connections:
      - event:
          type: dns
          dst_ip: 8.8.8.8
          dst_port: 53
          name: example.com
        verdict: allow

  - name: DNS-only rule blocks HTTPS egress
    policy: |
      8.8.8.8:53/udp
      dns:example.com
    connections:
      - event:
          type: https
          dst_ip: 93.184.216.34
          dst_port: 443
          host: example.com
        verdict: block

  - name: DNS-only rule blocks TCP egress
    policy: |
      8.8.8.8:53/udp
      dns:example.com
    connections:
      - event:
          type: tcp
          dst_ip: 93.184.216.34
          dst_port: 22
          host: example.com
        verdict: block

  - name: DNS-only wildcard allows DNS for subdomains
    policy: |
      8.8.8.8:53/udp
      dns:*.example.com
    connections:
      - event:
          type: dns
          dst_ip: 8.8.8.8
          dst_port: 53
          name: api.example.com
        verdict: allow
      - event:
          type: dns
          dst_ip: 8.8.8.8
          dst_port: 53
          name: deep.nested.example.com
        verdict: allow

  - name: DNS-only wildcard blocks HTTPS for subdomains
    policy: |
      8.8.8.8:53/udp
      dns:*.example.com
    connections:
      - event:
          type: https
          dst_ip: 1.2.3.4
          dst_port: 443
          host: api.example.com
        verdict: block

  - name: Normal rule allows both DNS and egress
    policy: |
      8.8.8.8:53/udp
      github.com
    connections:
      - event:
          type: dns
          dst_ip: 8.8.8.8
          dst_port: 53
          name: github.com
        verdict: allow
      - event:
          type: https
          dst_ip: 140.82.121.4
          dst_port: 443
          host: github.com
        verdict: allow

  - name: Mixed DNS-only and normal rules
    policy: |
      8.8.8.8:53/udp
      dns:resolve-only.com
      github.com
    connections:
      # DNS-only rule allows DNS
      - event:
          type: dns
          dst_ip: 8.8.8.8
          dst_port: 53
          name: resolve-only.com
        verdict: allow
      # DNS-only rule blocks egress
      - event:
          type: https
          dst_ip: 1.2.3.4
          dst_port: 443
          host: resolve-only.com
        verdict: block
      # Normal rule allows DNS
      - event:
          type: dns
          dst_ip: 8.8.8.8
          dst_port: 53
          name: github.com
        verdict: allow
      # Normal rule allows egress
      - event:
          type: https
          dst_ip: 140.82.121.4
          dst_port: 443
          host: github.com
        verdict: allow

  - name: DNS-only rule with exe attribute
    policy: |
      8.8.8.8:53/udp
      dns:example.com exe=/usr/bin/curl
    connections:
      # Matching exe - allowed
      - event:
          type: dns
          dst_ip: 8.8.8.8
          dst_port: 53
          name: example.com
          exe: /usr/bin/curl
        verdict: allow
      # Non-matching exe - blocked
      - event:
          type: dns
          dst_ip: 8.8.8.8
          dst_port: 53
          name: example.com
          exe: /usr/bin/wget
        verdict: block
      # No exe in event - blocked
      - event:
          type: dns
          dst_ip: 8.8.8.8
          dst_port: 53
          name: example.com
        verdict: block

  - name: DNS-only wildcard rule with cgroup attribute
    policy: |
      8.8.8.8:53/udp
      dns:*.internal.corp cgroup=/system.slice/myservice.service
    connections:
      # Matching cgroup - allowed
      - event:
          type: dns
          dst_ip: 8.8.8.8
          dst_port: 53
          name: api.internal.corp
          cgroup: /system.slice/myservice.service
        verdict: allow
      # Non-matching cgroup - blocked
      - event:
          type: dns
          dst_ip: 8.8.8.8
          dst_port: 53
          name: api.internal.corp
          cgroup: /user.slice/other.service
        verdict: block
