# Test suite for policy flattening
# Tests accurate conversion of policies with headers into flat, self-sufficient rules
#
# Each test case has:
#   - name: Test description
#   - policy: Input policy text (with headers, comments, etc.)
#   - rules: Expected list of flattened rules (each rule is fully self-contained)
#
# Flattened rule structure:
#   - type: "host" | "wildcard_host" | "ip" | "cidr" | "url" | "path"
#   - target: The main target (hostname, IP, CIDR, URL path)
#   - port: Port number, list of ports, or "*" for any
#   - protocol: "tcp" | "udp"
#   - methods: List of HTTP methods (for URL rules) or null
#   - url_base: Base URL for path rules (from header) or null
#   - attrs: Dict of attributes (exe, arg, step, cgroup, etc.) or empty

tests:
  # =============================================================================
  # Basic rules with implicit defaults
  # =============================================================================

  - name: Simple hostname with implicit defaults
    policy: |
      github.com
    rules:
      - type: host
        target: github.com
        port: [443]
        protocol: tcp
        methods: null
        url_base: null
        attrs: {}

  - name: Wildcard hostname
    policy: |
      *.github.com
    rules:
      - type: wildcard_host
        target: github.com
        port: [443]
        protocol: tcp
        methods: null
        url_base: null
        attrs: {}

  - name: IP address
    policy: |
      8.8.8.8
    rules:
      - type: ip
        target: 8.8.8.8
        port: [443]
        protocol: tcp
        methods: null
        url_base: null
        attrs: {}

  - name: CIDR block
    policy: |
      10.0.0.0/8
    rules:
      - type: cidr
        target: 10.0.0.0/8
        port: [443]
        protocol: tcp
        methods: null
        url_base: null
        attrs: {}

  # =============================================================================
  # Explicit port and protocol
  # =============================================================================

  - name: Host with explicit port
    policy: |
      github.com:22
    rules:
      - type: host
        target: github.com
        port: [22]
        protocol: tcp
        methods: null
        url_base: null
        attrs: {}

  - name: Host with multiple ports
    policy: |
      github.com:80|443
    rules:
      - type: host
        target: github.com
        port: [80, 443]
        protocol: tcp
        methods: null
        url_base: null
        attrs: {}

  - name: Host with any port
    policy: |
      github.com:*
    rules:
      - type: host
        target: github.com
        port: "*"
        protocol: tcp
        methods: null
        url_base: null
        attrs: {}

  - name: IP with UDP protocol
    policy: |
      8.8.8.8:53/udp
    rules:
      - type: ip
        target: 8.8.8.8
        port: [53]
        protocol: udp
        methods: null
        url_base: null
        attrs: {}

  - name: Host with explicit TCP (redundant but valid)
    policy: |
      github.com:22/tcp
    rules:
      - type: host
        target: github.com
        port: [22]
        protocol: tcp
        methods: null
        url_base: null
        attrs: {}

  # =============================================================================
  # URL rules
  # =============================================================================

  - name: URL with path wildcard
    policy: |
      https://github.com/*
    rules:
      - type: url
        target: https://github.com/*
        port: [443]
        protocol: tcp
        methods: ["GET", "HEAD"]
        url_base: null
        attrs: {}

  - name: URL with HTTP scheme
    policy: |
      http://example.com/api/*
    rules:
      - type: url
        target: http://example.com/api/*
        port: [80]
        protocol: tcp
        methods: ["GET", "HEAD"]
        url_base: null
        attrs: {}

  - name: URL with explicit method
    policy: |
      POST https://api.github.com/repos/*/issues
    rules:
      - type: url
        target: https://api.github.com/repos/*/issues
        port: [443]
        protocol: tcp
        methods: ["POST"]
        url_base: null
        attrs: {}

  - name: URL with multiple methods
    policy: |
      GET|POST https://api.github.com/repos/*
    rules:
      - type: url
        target: https://api.github.com/repos/*
        port: [443]
        protocol: tcp
        methods: ["GET", "POST"]
        url_base: null
        attrs: {}

  - name: URL with any method
    policy: |
      * https://api.github.com/*
    rules:
      - type: url
        target: https://api.github.com/*
        port: [443]
        protocol: tcp
        methods: ["*"]
        url_base: null
        attrs: {}

  # =============================================================================
  # Headers - port and protocol defaults
  # =============================================================================

  - name: Header sets default port
    policy: |
      [:22]
      github.com
      gitlab.com
    rules:
      - type: host
        target: github.com
        port: [22]
        protocol: tcp
        methods: null
        url_base: null
        attrs: {}
      - type: host
        target: gitlab.com
        port: [22]
        protocol: tcp
        methods: null
        url_base: null
        attrs: {}

  - name: Header sets port and protocol
    policy: |
      [:53/udp]
      8.8.8.8
      1.1.1.1
    rules:
      - type: ip
        target: 8.8.8.8
        port: [53]
        protocol: udp
        methods: null
        url_base: null
        attrs: {}
      - type: ip
        target: 1.1.1.1
        port: [53]
        protocol: udp
        methods: null
        url_base: null
        attrs: {}

  - name: Header with any port
    policy: |
      [:*]
      10.0.0.0/8
    rules:
      - type: cidr
        target: 10.0.0.0/8
        port: "*"
        protocol: tcp
        methods: null
        url_base: null
        attrs: {}

  # =============================================================================
  # URL base headers with attributes
  # =============================================================================

  - name: URL base header with exe attribute
    policy: |
      [https://github.com/ exe=/usr/lib/git-core/git-remote-http]
      GET /*/*/info/refs
      POST /*/*/git-upload-pack
    rules:
      - type: path
        target: "/*/*/info/refs"
        port: [443]
        protocol: tcp
        methods: ["GET"]
        url_base: "https://github.com/"
        attrs:
          exe: /usr/lib/git-core/git-remote-http
      - type: path
        target: "/*/*/git-upload-pack"
        port: [443]
        protocol: tcp
        methods: ["POST"]
        url_base: "https://github.com/"
        attrs:
          exe: /usr/lib/git-core/git-remote-http

  - name: URL base header with multiple attributes
    policy: |
      [https://api.github.com/ exe=/usr/bin/curl cgroup=/system.slice/*]
      GET /repos/*
    rules:
      - type: path
        target: "/repos/*"
        port: [443]
        protocol: tcp
        methods: ["GET"]
        url_base: "https://api.github.com/"
        attrs:
          exe: /usr/bin/curl
          cgroup: /system.slice/*

  - name: URL base header attrs can be overridden by rule attrs
    policy: |
      [https://api.github.com/ exe=/usr/bin/curl]
      GET /repos/* exe=/usr/bin/wget
    rules:
      - type: path
        target: "/repos/*"
        port: [443]
        protocol: tcp
        methods: ["GET"]
        url_base: "https://api.github.com/"
        attrs:
          exe: /usr/bin/wget

  # =============================================================================
  # Invalid rules (should be rejected/skipped)
  # =============================================================================

  - name: Invalid IP rejected as hostname (TLD must start with letter)
    policy: |
      256.0.0.0
      1.2.3
      999.999.999.999
      github.com
    rules:
      # Only github.com should parse - invalid IPs are rejected
      - type: host
        target: github.com
        port: [443]
        protocol: tcp
        methods: null
        url_base: null
        attrs: {}

  - name: Protocol suffix without port rejected
    policy: |
      github.com/udp
      8.8.8.8/udp
      github.com:53/udp
    rules:
      # Only the one with explicit port should parse
      - type: host
        target: github.com
        port: [53]
        protocol: udp
        methods: null
        url_base: null
        attrs: {}

  - name: URL with query string rejected
    policy: |
      https://api.github.com/search?q=test
      https://api.github.com/search
    rules:
      # Only the one without query string should parse
      - type: url
        target: https://api.github.com/search
        port: [443]
        protocol: tcp
        methods: ["GET", "HEAD"]
        url_base: null
        attrs: {}

  - name: URL with fragment rejected
    policy: |
      https://example.com/path#fragment
      https://example.com/path
    rules:
      # Only the one without fragment should parse
      - type: url
        target: https://example.com/path
        port: [443]
        protocol: tcp
        methods: ["GET", "HEAD"]
        url_base: null
        attrs: {}

  - name: Wildcard in URL hostname rejected
    policy: |
      https://*.github.com/foo
      https://api.github.com/*
    rules:
      # Wildcard in hostname rejected, wildcard in path OK
      - type: url
        target: https://api.github.com/*
        port: [443]
        protocol: tcp
        methods: ["GET", "HEAD"]
        url_base: null
        attrs: {}

  - name: Rule overrides header port
    policy: |
      [:22]
      github.com
      github.com:443
    rules:
      - type: host
        target: github.com
        port: [22]
        protocol: tcp
        methods: null
        url_base: null
        attrs: {}
      - type: host
        target: github.com
        port: [443]
        protocol: tcp
        methods: null
        url_base: null
        attrs: {}

  # =============================================================================
  # Headers - HTTP methods
  # =============================================================================

  - name: Header sets default methods
    policy: |
      [GET|HEAD]
      https://api.github.com/*
    rules:
      - type: url
        target: https://api.github.com/*
        port: [443]
        protocol: tcp
        methods: ["GET", "HEAD"]
        url_base: null
        attrs: {}

  - name: Header with POST method
    policy: |
      [POST]
      https://api.github.com/repos/*/issues
      https://api.github.com/repos/*/comments
    rules:
      - type: url
        target: https://api.github.com/repos/*/issues
        port: [443]
        protocol: tcp
        methods: ["POST"]
        url_base: null
        attrs: {}
      - type: url
        target: https://api.github.com/repos/*/comments
        port: [443]
        protocol: tcp
        methods: ["POST"]
        url_base: null
        attrs: {}

  # =============================================================================
  # Headers - URL base for path rules
  # =============================================================================

  - name: URL base header with path rules
    policy: |
      [https://api.github.com]
      GET /repos/*/releases
      POST /repos/*/issues
    rules:
      - type: path
        target: /repos/*/releases
        port: [443]
        protocol: tcp
        methods: ["GET"]
        url_base: https://api.github.com
        attrs: {}
      - type: path
        target: /repos/*/issues
        port: [443]
        protocol: tcp
        methods: ["POST"]
        url_base: https://api.github.com
        attrs: {}

  - name: URL base with path prefix
    policy: |
      [https://api.github.com/v1/repos]
      GET /*/releases
    rules:
      - type: path
        target: /*/releases
        port: [443]
        protocol: tcp
        methods: ["GET"]
        url_base: https://api.github.com/v1/repos
        attrs: {}

  - name: Path rules inherit method from header
    policy: |
      [GET|HEAD]
      [https://api.github.com]
      /repos/*/releases
    rules:
      - type: path
        target: /repos/*/releases
        port: [443]
        protocol: tcp
        methods: ["GET", "HEAD"]
        url_base: https://api.github.com
        attrs: {}

  # =============================================================================
  # Header reset
  # =============================================================================

  - name: Empty header resets to defaults
    policy: |
      [:22]
      github.com
      []
      gitlab.com
    rules:
      - type: host
        target: github.com
        port: [22]
        protocol: tcp
        methods: null
        url_base: null
        attrs: {}
      - type: host
        target: gitlab.com
        port: [443]
        protocol: tcp
        methods: null
        url_base: null
        attrs: {}

  - name: Header fully replaces previous header
    policy: |
      [:22]
      github.com
      [:80]
      example.com
    rules:
      - type: host
        target: github.com
        port: [22]
        protocol: tcp
        methods: null
        url_base: null
        attrs: {}
      - type: host
        target: example.com
        port: [80]
        protocol: tcp
        methods: null
        url_base: null
        attrs: {}

  # =============================================================================
  # Attributes
  # =============================================================================

  - name: Rule with exe attribute
    policy: |
      github.com exe=/usr/bin/curl
    rules:
      - type: host
        target: github.com
        port: [443]
        protocol: tcp
        methods: null
        url_base: null
        attrs:
          exe: /usr/bin/curl

  - name: Rule with wildcard exe
    policy: |
      github.com exe=*/node
    rules:
      - type: host
        target: github.com
        port: [443]
        protocol: tcp
        methods: null
        url_base: null
        attrs:
          exe: "*/node"

  - name: Rule with arg attribute
    policy: |
      github.com arg=--upload
    rules:
      - type: host
        target: github.com
        port: [443]
        protocol: tcp
        methods: null
        url_base: null
        attrs:
          arg: --upload

  - name: Rule with indexed arg
    policy: |
      github.com arg[0]=node arg[1]=build
    rules:
      - type: host
        target: github.com
        port: [443]
        protocol: tcp
        methods: null
        url_base: null
        attrs:
          arg[0]: node
          arg[1]: build

  - name: Rule with quoted arg (literal, no wildcards)
    policy: |
      github.com arg="hello world"
    rules:
      - type: host
        target: github.com
        port: [443]
        protocol: tcp
        methods: null
        url_base: null
        attrs:
          arg:
            value: "hello world"
            literal: true

  - name: Rule with backtick arg (wildcards active)
    policy: |
      github.com arg=`hello *.txt`
    rules:
      - type: host
        target: github.com
        port: [443]
        protocol: tcp
        methods: null
        url_base: null
        attrs:
          arg:
            value: "hello *.txt"
            literal: false

  - name: Rule with step attribute
    policy: |
      github.com step=my-build
    rules:
      - type: host
        target: github.com
        port: [443]
        protocol: tcp
        methods: null
        url_base: null
        attrs:
          step: my-build

  - name: Rule with cgroup attribute
    policy: |
      github.com cgroup=@docker
    rules:
      - type: host
        target: github.com
        port: [443]
        protocol: tcp
        methods: null
        url_base: null
        attrs:
          cgroup: "@docker"

  - name: Rule with multiple attributes
    policy: |
      github.com:22 exe=/usr/bin/ssh step=deploy
    rules:
      - type: host
        target: github.com
        port: [22]
        protocol: tcp
        methods: null
        url_base: null
        attrs:
          exe: /usr/bin/ssh
          step: deploy

  # =============================================================================
  # Header attributes (exe, cgroup, etc.)
  # =============================================================================

  - name: Header with exe attribute
    policy: |
      [exe=`/usr/lib/git-core/git-remote-*`]
      github.com
      *.github.com
    rules:
      - type: host
        target: github.com
        port: [443]
        protocol: tcp
        methods: null
        url_base: null
        attrs:
          exe:
            value: "/usr/lib/git-core/git-remote-*"
            literal: false
      - type: wildcard_host
        target: github.com
        port: [443]
        protocol: tcp
        methods: null
        url_base: null
        attrs:
          exe:
            value: "/usr/lib/git-core/git-remote-*"
            literal: false

  - name: Header with cgroup attribute
    policy: |
      [cgroup=`/azure.slice/*`]
      168.63.129.16
    rules:
      - type: ip
        target: 168.63.129.16
        port: [443]
        protocol: tcp
        methods: null
        url_base: null
        attrs:
          cgroup:
            value: "/azure.slice/*"
            literal: false

  - name: Header with port and exe attribute
    policy: |
      [:22 exe=/usr/bin/ssh]
      github.com
      gitlab.com
    rules:
      - type: host
        target: github.com
        port: [22]
        protocol: tcp
        methods: null
        url_base: null
        attrs:
          exe: /usr/bin/ssh
      - type: host
        target: gitlab.com
        port: [22]
        protocol: tcp
        methods: null
        url_base: null
        attrs:
          exe: /usr/bin/ssh

  - name: Header with multiple kv attributes
    policy: |
      [exe=/usr/bin/node cgroup=`/system.slice/*`]
      api.example.com
    rules:
      - type: host
        target: api.example.com
        port: [443]
        protocol: tcp
        methods: null
        url_base: null
        attrs:
          exe: /usr/bin/node
          cgroup:
            value: "/system.slice/*"
            literal: false

  - name: Rule attribute overrides header attribute
    policy: |
      [exe=/default/path]
      host1.com
      host2.com exe=/override/path
    rules:
      - type: host
        target: host1.com
        port: [443]
        protocol: tcp
        methods: null
        url_base: null
        attrs:
          exe: /default/path
      - type: host
        target: host2.com
        port: [443]
        protocol: tcp
        methods: null
        url_base: null
        attrs:
          exe: /override/path

  - name: Header attrs reset on new header
    policy: |
      [exe=/usr/bin/curl]
      example.com
      []
      github.com
    rules:
      - type: host
        target: example.com
        port: [443]
        protocol: tcp
        methods: null
        url_base: null
        attrs:
          exe: /usr/bin/curl
      - type: host
        target: github.com
        port: [443]
        protocol: tcp
        methods: null
        url_base: null
        attrs: {}

  - name: Header with port, protocol, and exe
    policy: |
      [:53/udp exe=/usr/bin/dig]
      8.8.8.8
      1.1.1.1
    rules:
      - type: ip
        target: 8.8.8.8
        port: [53]
        protocol: udp
        methods: null
        url_base: null
        attrs:
          exe: /usr/bin/dig
      - type: ip
        target: 1.1.1.1
        port: [53]
        protocol: udp
        methods: null
        url_base: null
        attrs:
          exe: /usr/bin/dig

  # =============================================================================
  # Comments and blank lines
  # =============================================================================

  - name: Comments and blank lines are ignored
    policy: |
      # This is a comment
      github.com

      # Another comment
      gitlab.com
    rules:
      - type: host
        target: github.com
        port: [443]
        protocol: tcp
        methods: null
        url_base: null
        attrs: {}
      - type: host
        target: gitlab.com
        port: [443]
        protocol: tcp
        methods: null
        url_base: null
        attrs: {}

  - name: Inline comments are stripped
    policy: |
      github.com # main site
      gitlab.com:22 # SSH access
    rules:
      - type: host
        target: github.com
        port: [443]
        protocol: tcp
        methods: null
        url_base: null
        attrs: {}
      - type: host
        target: gitlab.com
        port: [22]
        protocol: tcp
        methods: null
        url_base: null
        attrs: {}

  # =============================================================================
  # Complex realistic policy
  # =============================================================================

  - name: Complex realistic policy
    policy: |
      # Package registries
      registry.npmjs.org
      *.npmjs.org

      # GitHub API with path restrictions
      [https://api.github.com]
      GET /repos/*/releases
      POST /repos/*/issues

      # DNS (UDP)
      [:53/udp]
      8.8.8.8
      1.1.1.1

      # SSH access
      [:22]
      github.com

      # Internal network (any port)
      [:*]
      10.0.0.0/8
    rules:
      - type: host
        target: registry.npmjs.org
        port: [443]
        protocol: tcp
        methods: null
        url_base: null
        attrs: {}
      - type: wildcard_host
        target: npmjs.org
        port: [443]
        protocol: tcp
        methods: null
        url_base: null
        attrs: {}
      - type: path
        target: /repos/*/releases
        port: [443]
        protocol: tcp
        methods: ["GET"]
        url_base: https://api.github.com
        attrs: {}
      - type: path
        target: /repos/*/issues
        port: [443]
        protocol: tcp
        methods: ["POST"]
        url_base: https://api.github.com
        attrs: {}
      - type: ip
        target: 8.8.8.8
        port: [53]
        protocol: udp
        methods: null
        url_base: null
        attrs: {}
      - type: ip
        target: 1.1.1.1
        port: [53]
        protocol: udp
        methods: null
        url_base: null
        attrs: {}
      - type: host
        target: github.com
        port: [22]
        protocol: tcp
        methods: null
        url_base: null
        attrs: {}
      - type: cidr
        target: 10.0.0.0/8
        port: "*"
        protocol: tcp
        methods: null
        url_base: null
        attrs: {}
