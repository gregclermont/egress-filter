name: Test raw socket bypass

on:
  push:
    branches: [research/raw-socket-bypass]
  workflow_dispatch:

jobs:
  test-raw-sockets:
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - uses: actions/checkout@v4

      # First, test WITHOUT proxy to see baseline capabilities
      - name: Test raw sockets (no proxy)
        run: |
          echo "=== Testing raw socket capabilities WITHOUT proxy ==="
          sudo python3 experiments/raw_socket_bypass/test_raw_sockets.py

      # Now set up the proxy (use branch reference to get pre/post hooks)
      - name: Setup egress filter
        uses: gregclermont/egress-filter@research/raw-socket-bypass
        env:
          VERBOSE: "1"

      # Test WITH proxy running
      - name: Test raw sockets (with proxy)
        run: |
          echo "=== Testing raw socket capabilities WITH proxy ==="
          sudo python3 experiments/raw_socket_bypass/test_raw_sockets.py

      # Check if raw packets appeared in proxy logs
      - name: Check proxy logs for raw packets
        if: always()
        run: |
          echo "=== Connection events (should NOT show raw socket traffic if bypassed) ==="
          cat /tmp/connections.jsonl || echo "No connections log"
          echo ""
          echo "=== Looking for port 44444 (our test source port) ==="
          grep -i "44444" /tmp/connections.jsonl || echo "Not found - raw packet bypassed proxy!"

      - name: Show proxy logs
        if: always()
        run: |
          echo "=== Proxy log ==="
          cat /tmp/proxy.log || echo "No proxy log"

      # Test if we can use scapy for more sophisticated bypass
      - name: Test scapy bypass
        continue-on-error: true
        run: |
          echo "=== Testing scapy (using action's venv) ==="
          # The action sets EGRESS_FILTER_ROOT to its installation directory
          VENV_PYTHON="${EGRESS_FILTER_ROOT:-.}/.venv/bin/python"
          echo "Using: $VENV_PYTHON"
          sudo "$VENV_PYTHON" -c "
          from scapy.all import *
          import sys

          print('Scapy available, testing packet crafting...')

          # Try to send a SYN packet via raw socket
          try:
              pkt = IP(dst='93.184.216.34')/TCP(sport=55555, dport=80, flags='S')
              print(f'Crafted packet: {pkt.summary()}')

              # send() uses raw sockets
              send(pkt, verbose=True)
              print('SUCCESS: Packet sent via scapy - may have bypassed proxy!')
          except Exception as e:
              print(f'FAILED: {e}')
          "

      - name: Final connection log check
        if: always()
        run: |
          echo "=== Final connection log ==="
          cat /tmp/connections.jsonl || echo "No connections log"
          echo ""
          echo "=== Checking for scapy test (port 55555) ==="
          grep -i "55555" /tmp/connections.jsonl || echo "Port 55555 not found - scapy bypassed proxy!"

      # Test blocking methods
      - name: Test blocking methods
        run: |
          echo "=== Testing methods to block raw sockets ==="
          sudo python3 experiments/raw_socket_bypass/test_blocking_methods.py

      # Test if capsh can actually block raw sockets for a real connection
      - name: Test capsh blocking in practice
        run: |
          echo "=== Testing capsh blocking with real network request ==="

          # First, show that curl works normally
          echo "1. Normal curl (should work):"
          curl -s -o /dev/null -w "%{http_code}" https://example.com || echo "failed"

          # Now try with CAP_NET_RAW dropped - should still work for normal connections
          echo ""
          echo "2. Curl with CAP_NET_RAW dropped (should still work - doesn't need raw sockets):"
          sudo capsh --drop=cap_net_raw -- -c 'curl -s -o /dev/null -w "%{http_code}" https://example.com' || echo "failed"

          # Try raw socket with capsh drop
          echo ""
          echo "3. Raw socket test with CAP_NET_RAW dropped (should FAIL):"
          sudo capsh --drop=cap_net_raw -- -c "python3 -c \"
          import socket
          try:
              s = socket.socket(socket.AF_INET, socket.SOCK_RAW, 6)
              print('FAIL: Raw socket created!')
              s.close()
          except PermissionError as e:
              print(f'SUCCESS: Raw socket blocked - {e}')
          except Exception as e:
              print(f'ERROR: {e}')
          \""

          echo ""
          echo "4. AF_PACKET test with CAP_NET_RAW dropped (should FAIL):"
          sudo capsh --drop=cap_net_raw -- -c "python3 -c \"
          import socket
          try:
              s = socket.socket(socket.AF_PACKET, socket.SOCK_RAW, 3)
              print('FAIL: AF_PACKET socket created!')
              s.close()
          except PermissionError as e:
              print(f'SUCCESS: AF_PACKET blocked - {e}')
          except Exception as e:
              print(f'ERROR: {e}')
          \""
