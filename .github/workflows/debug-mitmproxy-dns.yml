name: Debug mitmproxy DNS

on:
  workflow_dispatch:

jobs:
  debug-dns:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y wireguard-tools resolvconf dnsutils
          uv sync
          uv pip install mitmproxy

      - name: Test 1 - Basic DNS resolution on host
        run: |
          echo "=== Host DNS config ==="
          cat /etc/resolv.conf
          echo ""
          echo "=== Test DNS resolution ==="
          nslookup example.com
          dig example.com +short

      - name: Test 2 - mitmproxy DNS mode (no WireGuard)
        run: |
          VENV_BIN=$(dirname $(uv python find))

          echo "=== Starting mitmproxy in DNS mode ==="
          # Run mitmproxy as a DNS server only
          sudo $VENV_BIN/mitmdump --mode dns@5353 > /tmp/dns-test.log 2>&1 &
          sleep 3

          echo "=== Test DNS query through mitmproxy ==="
          dig @127.0.0.1 -p 5353 example.com || echo "DNS query failed"

          echo "=== mitmproxy DNS logs ==="
          cat /tmp/dns-test.log

          sudo pkill -f mitmdump || true

      - name: Test 3 - Check mitmproxy WireGuard network setup
        run: |
          VENV_BIN=$(dirname $(uv python find))

          echo "=== Starting mitmproxy in WireGuard mode ==="
          sudo env PYTHONUNBUFFERED=1 $VENV_BIN/mitmdump \
            --mode wireguard \
            --set block_global=false \
            > /tmp/wg-test.log 2>&1 &

          sleep 5

          echo "=== mitmproxy output ==="
          cat /tmp/wg-test.log

          echo ""
          echo "=== Network interfaces ==="
          ip addr

          echo ""
          echo "=== Routing table ==="
          ip route

          echo ""
          echo "=== Can mitmproxy process reach DNS? ==="
          # Test if mitmproxy's process can reach external DNS
          sudo nsenter -t $(pgrep -f mitmdump) -n nslookup example.com 8.8.8.8 || echo "nsenter failed, trying direct"

          # Try direct from host
          nslookup example.com 8.8.8.8 || echo "Direct DNS also failed"

          sudo pkill -f mitmdump || true

      - name: Test 4 - WireGuard with DNS bypass routes
        run: |
          VENV_BIN=$(dirname $(uv python find))

          # Get default gateway before WireGuard
          DEFAULT_GW=$(ip route | grep default | awk '{print $3}')
          DEFAULT_IF=$(ip route | grep default | awk '{print $5}')
          echo "Default gateway: $DEFAULT_GW via $DEFAULT_IF"

          echo "=== Starting mitmproxy ==="
          sudo env PYTHONUNBUFFERED=1 $VENV_BIN/mitmdump \
            --mode wireguard \
            --set block_global=false \
            > /tmp/wg-full.log 2>&1 &

          # Wait for config
          for i in {1..15}; do
            if grep -q "Endpoint" /tmp/wg-full.log; then break; fi
            sleep 1
          done

          cat /tmp/wg-full.log

          # Extract config - IMPORTANT: Skip DNS to avoid resolver loop
          python3 << 'EOF'
          import re
          with open("/tmp/wg-full.log") as f:
              content = f.read()

          config = []
          in_config = False
          for line in content.split('\n'):
              if '[Interface]' in line:
                  in_config = True
                  config.append('[Interface]')
              elif in_config:
                  if line.strip().startswith('---'):
                      break
                  # Skip DNS to prevent resolv.conf modification that causes loop
                  for key in ['PrivateKey', 'Address', 'PublicKey', 'AllowedIPs', 'Endpoint']:
                      if key in line and '=' in line:
                          match = re.search(rf'{key}\s*=\s*(.+)', line)
                          if match:
                              config.append(f'{key} = {match.group(1).strip()}')
                  if '[Peer]' in line:
                      config.append('')
                      config.append('[Peer]')

          print("Config (DNS removed to prevent loop):")
          print('\n'.join(config))
          with open('/tmp/wg.conf', 'w') as f:
              f.write('\n'.join(config))
          EOF

          echo "=== Setup WireGuard ==="
          sudo cp /tmp/wg.conf /etc/wireguard/wg0.conf
          sudo wg-quick up wg0

          echo ""
          echo "=== Add bypass routes for upstream DNS servers ==="
          # Add explicit routes to bypass WireGuard for DNS servers
          sudo ip route add 8.8.8.8/32 via $DEFAULT_GW dev $DEFAULT_IF
          sudo ip route add 8.8.4.4/32 via $DEFAULT_GW dev $DEFAULT_IF
          sudo ip route add 1.1.1.1/32 via $DEFAULT_GW dev $DEFAULT_IF

          echo ""
          echo "=== Routing table after bypass routes ==="
          ip route

          echo ""
          echo "=== Test DNS through mitmproxy (10.0.0.53) ==="
          dig @10.0.0.53 example.com +short +timeout=5 || echo "DNS via mitmproxy failed"

          echo ""
          echo "=== Test direct DNS to 8.8.8.8 (bypassed) ==="
          dig @8.8.8.8 example.com +short +timeout=5 || echo "Direct DNS failed"

          echo ""
          echo "=== mitmproxy logs ==="
          cat /tmp/wg-full.log

          sudo wg-quick down wg0 || true
          sudo pkill -f mitmdump || true

      - name: Test 5 - Check mitmproxy's ability to resolve DNS itself
        run: |
          VENV_BIN=$(dirname $(uv python find))

          echo "=== Test Python DNS resolution ==="
          $VENV_BIN/python -c "
          import socket
          try:
              result = socket.gethostbyname('example.com')
              print(f'Resolved example.com to {result}')
          except Exception as e:
              print(f'Failed: {e}')
          "

          echo ""
          echo "=== Test with mitmproxy's resolver ==="
          $VENV_BIN/python -c "
          import asyncio
          try:
              from mitmproxy.net.dns import resolver
              print('mitmproxy resolver module loaded')
          except ImportError as e:
              print(f'Import error: {e}')
          "
