name: Test sfw-free compatibility

on:
  push:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  test:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Setup egress filter
        uses: gregclermont/egress-filter@sfw

      - name: Install sfw-free
        run: npm install -g sfw

      - name: Use sfw to install a package
        run: |
          mkdir test-project && cd test-project
          npm init -y
          sfw npm install is-odd

      - name: Verify installation
        run: |
          cd test-project
          node -e "console.log('is-odd(3):', require('is-odd')(3))"

      - name: Test malware blocking
        run: |
          cd test-project
          echo "Attempting to install known malware package (should be blocked)..."
          # atg-atgse is a known malware package (data exfiltration)
          if npm install atg-atgse@1.0.0 2>&1; then
            echo "ERROR: Malware package was NOT blocked!"
            exit 1
          else
            echo "Package was blocked as expected"
          fi

      - name: Verify blocking in logs
        run: |
          echo "Checking proxy logs for SECURITY BLOCKED message..."
          grep -q "SECURITY BLOCKED" /tmp/proxy.log || {
            echo "ERROR: No SECURITY BLOCKED message found in proxy logs"
            cat /tmp/proxy.log
            exit 1
          }
          echo "Found SECURITY BLOCKED message"
          grep "SECURITY BLOCKED" /tmp/proxy.log

      - name: Test Cargo package security check
        run: |
          mkdir -p cargo-test && cd cargo-test
          # Create minimal Cargo.toml
          cat > Cargo.toml << 'CARGO_EOF'
          [package]
          name = "test"
          version = "0.1.0"
          edition = "2021"

          [dependencies]
          itoa = "1.0.0"
          CARGO_EOF
          mkdir -p src && echo 'fn main() {}' > src/main.rs
          # Fetch dependencies (this triggers crates.io download)
          cargo fetch 2>&1 || true

      - name: Verify Cargo security check in logs
        run: |
          echo "Checking proxy logs for Cargo security check..."
          grep -q "SECURITY checking pkg:cargo" /tmp/proxy.log || {
            echo "WARNING: No Cargo security check found in logs"
            echo "This may be expected if cargo uses a different download method"
          }
          grep "SECURITY checking pkg:cargo" /tmp/proxy.log || echo "(no cargo checks found)"
          grep "crates.io\|static.crates.io" /tmp/proxy.log | head -10 || echo "(no crates.io requests found)"

      - name: Test Cargo malware blocking
        run: |
          mkdir -p cargo-malware-test && cd cargo-malware-test
          cat > Cargo.toml << 'CARGO_EOF'
          [package]
          name = "test"
          version = "0.1.0"
          edition = "2021"

          [dependencies]
          faster-log = "=1.7.8"
          CARGO_EOF
          mkdir -p src && echo 'fn main() {}' > src/main.rs
          echo "Attempting to fetch malicious cargo package (should be blocked)..."
          # faster-log 1.7.8 is malware (typosquat of fast_log, exfiltrates crypto keys)
          if cargo fetch 2>&1; then
            echo "ERROR: Malware package was NOT blocked!"
            exit 1
          else
            echo "Cargo package was blocked as expected"
          fi

      - name: Verify Cargo blocking in logs
        run: |
          echo "Checking proxy logs for Cargo SECURITY BLOCKED message..."
          grep "SECURITY BLOCKED pkg:cargo/faster-log" /tmp/proxy.log || {
            echo "ERROR: No Cargo blocking message found"
            grep "faster-log" /tmp/proxy.log || echo "(no faster-log in logs)"
            exit 1
          }

      - name: Show proxy logs
        if: always()
        run: |
          echo "=== Proxy Log ==="
          cat /tmp/proxy.log || echo "No log file found"
