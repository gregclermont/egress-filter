name: Test sfw-free compatibility

on:
  push:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  test:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Setup egress filter
        uses: gregclermont/egress-filter@sfw

      - name: Install sfw-free
        if: false  # Skip for now
        run: npm install -g sfw

      - name: Use sfw to install a package
        if: false  # Skip for now
        run: |
          mkdir test-project && cd test-project
          npm init -y
          sfw npm install is-odd

      - name: Verify installation
        if: false  # Skip for now
        run: |
          cd test-project
          node -e "console.log('is-odd(3):', require('is-odd')(3))"

      - name: Test malware blocking
        if: false  # Skip for now
        run: |
          cd test-project
          echo "Attempting to install known malware package (should be blocked)..."
          # atg-atgse is a known malware package (data exfiltration)
          if npm install atg-atgse@1.0.0 2>&1; then
            echo "ERROR: Malware package was NOT blocked!"
            exit 1
          else
            echo "Package was blocked as expected"
          fi

      - name: Verify blocking in logs
        if: false  # Skip for now
        run: |
          echo "Checking proxy logs for SECURITY BLOCKED message..."
          grep -q "SECURITY BLOCKED" /tmp/proxy.log || {
            echo "ERROR: No SECURITY BLOCKED message found in proxy logs"
            cat /tmp/proxy.log
            exit 1
          }
          echo "Found SECURITY BLOCKED message"
          grep "SECURITY BLOCKED" /tmp/proxy.log

      - name: Test Cargo package security check
        if: false  # Skip for now
        run: |
          mkdir -p cargo-test && cd cargo-test
          # Create minimal Cargo.toml
          cat > Cargo.toml << 'CARGO_EOF'
          [package]
          name = "test"
          version = "0.1.0"
          edition = "2021"

          [dependencies]
          itoa = "1.0.0"
          CARGO_EOF
          mkdir -p src && echo 'fn main() {}' > src/main.rs
          # Fetch dependencies (this triggers crates.io download)
          cargo fetch 2>&1 || true

      - name: Verify Cargo security check in logs
        if: false  # Skip for now
        run: |
          echo "Checking proxy logs for Cargo security check..."
          grep -q "SECURITY checking pkg:cargo" /tmp/proxy.log || {
            echo "WARNING: No Cargo security check found in logs"
            echo "This may be expected if cargo uses a different download method"
          }
          grep "SECURITY checking pkg:cargo" /tmp/proxy.log || echo "(no cargo checks found)"
          grep "crates.io\|static.crates.io" /tmp/proxy.log | head -10 || echo "(no crates.io requests found)"

      - name: Test raw Python requests (baseline)
        run: |
          # Test that Python requests works through the proxy
          python3 -c "
          import requests
          print('Testing raw requests library...')
          r = requests.get('https://pypi.org/simple/requests/')
          print(f'Status: {r.status_code}')
          print(f'Content-Length: {len(r.content)}')
          print('Raw requests: OK')
          "

      - name: Test CacheControlAdapter (diagnose Poetry issue)
        run: |
          # Use venv to avoid permission issues
          python3 -m venv /tmp/test-venv
          /tmp/test-venv/bin/pip install cachecontrol requests
          /tmp/test-venv/bin/python -c "
          import requests
          from cachecontrol import CacheControlAdapter
          import time

          print('Testing CacheControlAdapter...')
          session = requests.Session()
          adapter = CacheControlAdapter()
          session.mount('http://', adapter)
          session.mount('https://', adapter)

          # Test single request
          r = session.get('https://pypi.org/simple/requests/')
          print(f'Single request - Status: {r.status_code}, Length: {len(r.content)}')

          # Test multiple rapid requests (like Poetry does)
          print('Testing multiple rapid requests...')
          for i in range(6):
              try:
                  # Force new session to simulate Poetry's retry behavior
                  session2 = requests.Session()
                  session2.mount('https://', CacheControlAdapter())
                  r2 = session2.get('https://pypi.org/simple/requests/', timeout=5)
                  print(f'Request {i+1}: Status {r2.status_code}')
              except Exception as e:
                  print(f'Request {i+1}: FAILED - {e}')
          print('CacheControlAdapter: OK')
          "

      - name: Test Poetry (not supported by sfw, but works with transparent proxy)
        run: |
          # Create a virtual environment for poetry to avoid permission issues
          python3 -m venv /tmp/poetry-venv
          /tmp/poetry-venv/bin/pip install poetry

          # Create a poetry project
          mkdir -p /tmp/poetry-test && cd /tmp/poetry-test
          /tmp/poetry-venv/bin/poetry init --no-interaction --name test --dependency requests

          # Install the package with verbose output
          /tmp/poetry-venv/bin/poetry install --no-root -vvv

          # Verify it works
          /tmp/poetry-venv/bin/poetry run python -c "import requests; print('requests version:', requests.__version__)"

      - name: Verify Poetry security check in logs
        if: false  # Skip for now
        run: |
          echo "Checking proxy logs for PyPI security check from Poetry..."
          grep "SECURITY checking pkg:pypi/requests" /tmp/proxy.log || {
            echo "WARNING: No PyPI security check found for requests"
            echo "Checking for any pythonhosted.org traffic..."
          }
          grep "pythonhosted.org\|pypi.org" /tmp/proxy.log | head -10 || echo "(no PyPI requests found)"
          grep "SECURITY checking pkg:pypi" /tmp/proxy.log | head -5 || echo "(no pypi checks found)"

      - name: Show proxy logs
        if: always()
        run: |
          echo "=== Proxy Log ==="
          cat /tmp/proxy.log || echo "No log file found"
