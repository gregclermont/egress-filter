name: Test mitmproxy WireGuard

on:
  pull_request:
  workflow_dispatch:

jobs:
  test-mitmproxy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v4

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y wireguard-tools dnsutils

      - name: Install Python dependencies for tests
        run: uv sync

      - name: Setup mitmproxy user with dedicated uv install
        run: |
          # Create dedicated user for mitmproxy
          sudo useradd -r -m mitmproxy-user
          sudo mkdir -p /home/mitmproxy-user/.local/bin
          sudo chown -R mitmproxy-user:mitmproxy-user /home/mitmproxy-user

          # Install uv for mitmproxy-user (UV_UNMANAGED_INSTALL skips receipt file)
          sudo -u mitmproxy-user -H bash -c 'curl -LsSf https://astral.sh/uv/install.sh | UV_UNMANAGED_INSTALL=/home/mitmproxy-user/.local/bin sh'

          # Create venv and install mitmproxy
          sudo -i -u mitmproxy-user /home/mitmproxy-user/.local/bin/uv venv --python 3.12 /home/mitmproxy-user/venv
          sudo -i -u mitmproxy-user /home/mitmproxy-user/.local/bin/uv pip install --python /home/mitmproxy-user/venv/bin/python mitmproxy

          # Copy the logger script
          sudo cp mitmproxy_wg_logger.py /home/mitmproxy-user/
          sudo chown mitmproxy-user:mitmproxy-user /home/mitmproxy-user/mitmproxy_wg_logger.py

          # Mark packets from mitmproxy-user to bypass WireGuard routing
          sudo iptables -t mangle -A OUTPUT -m owner --uid-owner mitmproxy-user -j MARK --set-mark 0x1
          sudo ip rule add fwmark 0x1 lookup main priority 100

          echo "mitmproxy-user setup complete"

      - name: Start mitmproxy
        run: |
          LOGFILE=/home/mitmproxy-user/mitmproxy.log

          # Start mitmproxy as dedicated user using the pre-installed venv
          sudo -i -u mitmproxy-user bash -c '/home/mitmproxy-user/venv/bin/mitmdump \
            --mode wireguard \
            --set block_global=false \
            -s /home/mitmproxy-user/mitmproxy_wg_logger.py \
            > /home/mitmproxy-user/mitmproxy.log 2>&1' &

          MITMPROXY_PID=$!
          echo "MITMPROXY_PID=$MITMPROXY_PID" >> $GITHUB_ENV
          echo "LOGFILE=$LOGFILE" >> $GITHUB_ENV
          echo "Started mitmproxy wrapper with PID $MITMPROXY_PID"

          # Wait for mitmproxy to start
          echo "Waiting for mitmproxy to start..."
          for i in {1..60}; do
            if sudo cat $LOGFILE 2>/dev/null | grep -q "WireGuard server listening"; then
              echo "mitmproxy started"
              break
            fi
            # Check if the process is still running
            if ! ps -p $MITMPROXY_PID > /dev/null 2>&1; then
              echo "ERROR: mitmproxy process died"
              sudo cat $LOGFILE || echo "No log file"
              exit 1
            fi
            sleep 1
          done

          echo "=== mitmproxy log at startup ==="
          sudo cat $LOGFILE

      - name: Extract and setup WireGuard client
        run: |
          # Extract WireGuard config from mitmproxy output
          sudo cat $LOGFILE > /tmp/mitmproxy.log
          python3 << 'PYEOF'
          import re

          with open("/tmp/mitmproxy.log", "r") as f:
              content = f.read()

          config_lines = []
          in_config = False

          for line in content.split('\n'):
              if '[Interface]' in line:
                  in_config = True
                  config_lines.append('[Interface]')
                  continue

              if not in_config:
                  continue

              if '[Peer]' in line:
                  config_lines.append('')
                  config_lines.append('[Peer]')
                  continue

              if line.strip().startswith('---'):
                  break

              # Extract keys (skip DNS to use system resolver)
              for key in ['PrivateKey', 'Address', 'PublicKey', 'AllowedIPs', 'Endpoint']:
                  if key in line and '=' in line:
                      match = re.search(rf'{key}\s*=\s*(.+)', line)
                      if match:
                          value = match.group(1).strip()
                          config_lines.append(f'{key} = {value}')
                          break

          config = '\n'.join(config_lines)
          print("=== WireGuard client config ===")
          print(config)

          with open("/tmp/wg-client.conf", "w") as f:
              f.write(config)
          PYEOF

          # Setup WireGuard client on host
          sudo cp /tmp/wg-client.conf /etc/wireguard/wg0.conf
          sudo wg-quick up wg0

          echo ""
          echo "=== WireGuard status ==="
          sudo wg show

      - name: Run connection tests
        run: |
          sleep 2
          python3 test_mitmproxy_connections.py
          sleep 3

      - name: Show mitmproxy logs
        if: always()
        run: |
          echo "=== mitmproxy logs ==="
          sudo cat $LOGFILE || echo "No logs found"

      - name: Verify logged connections
        run: |
          echo "Checking for logged connections..."
          sudo cat $LOGFILE > /tmp/mitmproxy.log

          for pattern in "HTTP:" "DNS:" "TCP:" "UDP:"; do
            if grep -q "$pattern" /tmp/mitmproxy.log; then
              echo "PASS: $pattern found"
              grep "$pattern" /tmp/mitmproxy.log | head -3
            else
              echo "WARN: $pattern not found"
            fi
          done

          if grep -qE "(HTTP|DNS|TCP|UDP):" /tmp/mitmproxy.log; then
            echo "SUCCESS: Traffic was logged through mitmproxy"
          else
            echo "FAILED: No traffic was logged"
            exit 1
          fi

      - name: Cleanup
        if: always()
        run: |
          sudo wg-quick down wg0 || true
          sudo pkill -f mitmdump || true
          sudo userdel -r mitmproxy-user || true
