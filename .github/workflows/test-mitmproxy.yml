name: Test mitmproxy WireGuard

on:
  pull_request:
  workflow_dispatch:

jobs:
  test-mitmproxy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v4

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y wireguard-tools dnsutils

      - name: Install Python dependencies
        run: |
          uv sync
          uv pip install mitmproxy
          # Make venv accessible to mitmproxy-user
          chmod -R a+rX .venv

      - name: Setup mitmproxy user with fwmark bypass
        run: |
          # Create a dedicated user for mitmproxy
          # Traffic from this user will bypass the WireGuard tunnel
          sudo useradd -r -s /bin/false mitmproxy-user

          # Mark packets from mitmproxy user to skip WireGuard routing
          # This prevents the loop where mitmproxy's traffic goes through its own tunnel
          sudo iptables -t mangle -A OUTPUT -m owner --uid-owner mitmproxy-user -j MARK --set-mark 0x1

          # Add routing rule: marked packets use main table (bypass WireGuard)
          sudo ip rule add fwmark 0x1 lookup main priority 100

          echo "fwmark bypass configured for mitmproxy-user"

      - name: Start mitmproxy
        run: |
          VENV_BIN=$(dirname $(uv python find))

          # Run mitmproxy as the dedicated user so its traffic bypasses WireGuard
          sudo -u mitmproxy-user env \
            PATH="$VENV_BIN:$PATH" \
            HOME=/tmp \
            PYTHONUNBUFFERED=1 \
            $VENV_BIN/mitmdump \
              --mode wireguard \
              --set block_global=false \
              -s mitmproxy_wg_logger.py \
              > /tmp/mitmproxy.log 2>&1 &

          echo "MITMPROXY_PID=$!" >> $GITHUB_ENV

          # Wait for mitmproxy to start
          echo "Waiting for mitmproxy to start..."
          for i in {1..30}; do
            if grep -q "WireGuard server listening" /tmp/mitmproxy.log 2>/dev/null; then
              echo "mitmproxy started"
              break
            fi
            sleep 1
          done

          cat /tmp/mitmproxy.log

      - name: Extract and setup WireGuard client
        run: |
          # Extract WireGuard config from mitmproxy output
          python3 << 'PYEOF'
          import re

          with open("/tmp/mitmproxy.log", "r") as f:
              content = f.read()

          config_lines = []
          in_config = False

          for line in content.split('\n'):
              if '[Interface]' in line:
                  in_config = True
                  config_lines.append('[Interface]')
                  continue

              if not in_config:
                  continue

              if '[Peer]' in line:
                  config_lines.append('')
                  config_lines.append('[Peer]')
                  continue

              if line.strip().startswith('---'):
                  break

              # Extract keys (skip DNS to use system resolver)
              for key in ['PrivateKey', 'Address', 'PublicKey', 'AllowedIPs', 'Endpoint']:
                  if key in line and '=' in line:
                      match = re.search(rf'{key}\s*=\s*(.+)', line)
                      if match:
                          value = match.group(1).strip()
                          config_lines.append(f'{key} = {value}')
                          break

          config = '\n'.join(config_lines)
          print("=== WireGuard client config ===")
          print(config)

          with open("/tmp/wg-client.conf", "w") as f:
              f.write(config)
          PYEOF

          # Setup WireGuard client on host
          sudo cp /tmp/wg-client.conf /etc/wireguard/wg0.conf
          sudo wg-quick up wg0

          echo ""
          echo "=== WireGuard status ==="
          sudo wg show

      - name: Run connection tests
        run: |
          sleep 2
          python3 test_mitmproxy_connections.py
          sleep 3

      - name: Show mitmproxy logs
        if: always()
        run: |
          echo "=== mitmproxy logs ==="
          cat /tmp/mitmproxy.log || echo "No logs found"

      - name: Verify logged connections
        run: |
          echo "Checking for logged connections..."

          for pattern in "HTTP:" "DNS:" "TCP:" "UDP:"; do
            if grep -q "$pattern" /tmp/mitmproxy.log; then
              echo "PASS: $pattern found"
              grep "$pattern" /tmp/mitmproxy.log | head -3
            else
              echo "WARN: $pattern not found"
            fi
          done

          if grep -qE "(HTTP|DNS|TCP|UDP):" /tmp/mitmproxy.log; then
            echo "SUCCESS: Traffic was logged through mitmproxy"
          else
            echo "FAILED: No traffic was logged"
            exit 1
          fi

      - name: Cleanup
        if: always()
        run: |
          sudo wg-quick down wg0 || true
          sudo pkill -f mitmdump || true
          sudo userdel mitmproxy-user || true
