name: Test mitmproxy WireGuard

on:
  pull_request:
  workflow_dispatch:

jobs:
  test-mitmproxy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v4

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y wireguard-tools dnsutils

      - name: Install Python dependencies for tests
        run: uv sync

      - name: Start mitmproxy in Docker container
        run: |
          # Run mitmproxy in a Docker container to provide network isolation
          # The container has its own network stack so outbound traffic doesn't loop

          # Create a Docker network for mitmproxy
          docker network create --subnet=172.30.0.0/24 mitmproxy-net

          # Start mitmproxy container with privileged mode for WireGuard
          # (NET_ADMIN alone may not be enough for creating wg interfaces)
          # Use explicit DNS to avoid Docker DNS resolution issues
          docker run -d --name mitmproxy \
            --network mitmproxy-net \
            --ip 172.30.0.2 \
            --privileged \
            --dns 8.8.8.8 \
            --dns 8.8.4.4 \
            -p 51820:51820/udp \
            -v "$(pwd)/mitmproxy_wg_logger.py:/app/mitmproxy_wg_logger.py:ro" \
            -e PYTHONUNBUFFERED=1 \
            mitmproxy/mitmproxy:latest \
            mitmdump --mode wireguard --set block_global=false -s /app/mitmproxy_wg_logger.py

          # Verify container can reach the internet
          echo "=== Testing container connectivity ==="
          sleep 2
          docker exec mitmproxy ping -c 2 8.8.8.8 || echo "WARN: Cannot ping 8.8.8.8"
          docker exec mitmproxy nslookup example.com || echo "WARN: DNS lookup failed"

          # Wait for mitmproxy to start
          echo "Waiting for mitmproxy to start..."
          for i in {1..60}; do
            if docker logs mitmproxy 2>&1 | grep -q "WireGuard server listening"; then
              echo "mitmproxy started"
              break
            fi
            if ! docker ps -q -f name=mitmproxy | grep -q .; then
              echo "ERROR: mitmproxy container died"
              docker logs mitmproxy 2>&1
              exit 1
            fi
            # Show progress every 10 seconds
            if [ $((i % 10)) -eq 0 ]; then
              echo "Still waiting... ($i seconds)"
              docker logs mitmproxy 2>&1 | tail -5
            fi
            sleep 1
          done

          # Show logs
          echo "=== mitmproxy log at startup ==="
          docker logs mitmproxy 2>&1

      - name: Extract and setup WireGuard client
        run: |
          # Extract WireGuard config from docker logs
          docker logs mitmproxy 2>&1 > /tmp/mitmproxy.log
          python3 << 'PYEOF'
          import re

          with open("/tmp/mitmproxy.log", "r") as f:
              content = f.read()

          config_lines = []
          in_config = False

          for line in content.split('\n'):
              if '[Interface]' in line:
                  in_config = True
                  config_lines.append('[Interface]')
                  continue

              if not in_config:
                  continue

              if '[Peer]' in line:
                  config_lines.append('')
                  config_lines.append('[Peer]')
                  continue

              if line.strip().startswith('---'):
                  break

              # Extract keys (skip DNS to use system resolver)
              for key in ['PrivateKey', 'Address', 'PublicKey', 'AllowedIPs', 'Endpoint']:
                  if key in line and '=' in line:
                      match = re.search(rf'{key}\s*=\s*(.+)', line)
                      if match:
                          value = match.group(1).strip()
                          # Replace endpoint IP with localhost (port forwarded)
                          if key == 'Endpoint':
                              value = re.sub(r'^[\d.]+:', '127.0.0.1:', value)
                          config_lines.append(f'{key} = {value}')
                          break

          config = '\n'.join(config_lines)
          print("=== WireGuard client config ===")
          print(config)
          print()

          if not config.strip() or '[Interface]' not in config or '[Peer]' not in config:
              print("ERROR: Failed to extract valid WireGuard config from mitmproxy logs!")
              print()
              print("Raw log content:")
              print(content)
              import sys
              sys.exit(1)

          with open("/tmp/wg-client.conf", "w") as f:
              f.write(config)
          PYEOF

          # Setup WireGuard client on host
          sudo cp /tmp/wg-client.conf /etc/wireguard/wg0.conf
          sudo wg-quick up wg0

          echo ""
          echo "=== WireGuard status ==="
          sudo wg show

      - name: Run connection tests
        run: |
          sleep 2
          python3 test_mitmproxy_connections.py
          sleep 3

      - name: Show mitmproxy logs
        if: always()
        run: |
          echo "=== mitmproxy logs ==="
          docker logs mitmproxy 2>&1 || echo "No logs found"

      - name: Verify logged connections
        run: |
          echo "Checking for logged connections..."
          docker logs mitmproxy 2>&1 > /tmp/mitmproxy.log

          for pattern in "HTTP:" "DNS:" "TCP:" "UDP:"; do
            if grep -q "$pattern" /tmp/mitmproxy.log; then
              echo "PASS: $pattern found"
              grep "$pattern" /tmp/mitmproxy.log | head -3
            else
              echo "WARN: $pattern not found"
            fi
          done

          if grep -qE "(HTTP|DNS|TCP|UDP):" /tmp/mitmproxy.log; then
            echo "SUCCESS: Traffic was logged through mitmproxy"
          else
            echo "FAILED: No traffic was logged"
            exit 1
          fi

      - name: Cleanup
        if: always()
        run: |
          sudo wg-quick down wg0 || true
          docker stop mitmproxy || true
          docker rm mitmproxy || true
          docker network rm mitmproxy-net || true
