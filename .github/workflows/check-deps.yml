name: Check dependency updates

on:
  schedule:
    # Run weekly on Monday at 9am UTC
    - cron: '0 9 * * 1'
  workflow_dispatch: # Allow manual trigger
  push:
    branches: [feat/verified-deps]  # TODO: remove after testing

permissions:
  issues: write

jobs:
  check-deps:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Generate manifest
        run: |
          echo "=== Generated manifest ==="
          python3 src/setup/generate-deps.py | tee /tmp/generated-deps.sha256
          echo ""
          echo "=== Current manifest ==="
          cat src/setup/deps.sha256

      - name: Check for dependency updates
        id: check
        run: |
          if ! python3 src/setup/generate-deps.py --check src/setup/deps.sha256; then
            echo "updates_available=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Create issue if updates available
        if: steps.check.outputs.updates_available == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const title = 'Dependency updates available';

            // Check if issue already exists
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'dependencies'
            });

            if (issues.data.some(issue => issue.title === title)) {
              console.log('Issue already exists, skipping');
              return;
            }

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: `The dependency manifest \`src/setup/deps.sha256\` is out of date.

            This could mean:
            - A new version of a dependency is available
            - The content at a pinned URL has changed (review carefully for security)

            To update, run on an Ubuntu runner:
            \`\`\`bash
            python3 src/setup/generate-deps.py > src/setup/deps.sha256
            \`\`\`

            Then review the diff and commit.`,
              labels: ['dependencies']
            });
