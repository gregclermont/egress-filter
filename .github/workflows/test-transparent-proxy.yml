name: Test transparent proxy

on:
  push:
    branches: [test]
  workflow_dispatch:
    inputs:
      verbose:
        description: 'Enable verbose test output'
        type: boolean
        default: false

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  test:
    runs-on: ubuntu-latest
    timeout-minutes: 4
    steps:
      - name: Setup egress filter
        uses: gregclermont/egress-filter@test
        env:
          VERBOSE: ${{ inputs.verbose && '1' || '0' }}

      - uses: actions/checkout@v6
        with:
          sparse-checkout: tests
          fetch-depth: 1

      - name: Run connection tracking tests
        run: python3 tests/connection_tests/run.py --connections-log=/tmp/connections.jsonl

      - name: Show connection events
        if: always()
        run: cat /tmp/connections.jsonl || echo "No connections log found"

      - name: Show proxy logs
        if: always()
        env:
          VERBOSE: ${{ inputs.verbose && '1' || '0' }}
        run: |
          cat /tmp/proxy.log || echo "No proxy log found"
          if [ "$VERBOSE" = "1" ] && [ -f /tmp/mitmproxy.log ]; then
            echo ""
            echo "=== Mitmproxy Log (verbose) ==="
            cat /tmp/mitmproxy.log
          fi

      - name: Show conntrack marks (UDP fast-path)
        if: always()
        run: |
          echo "=== iptables mangle OUTPUT counters ==="
          sudo iptables -t mangle -L OUTPUT -v -n 2>/dev/null | head -20 || true
          echo ""
          echo "=== UDP connections with fast-path mark (4) ==="
          sudo conntrack -L -p udp 2>/dev/null | grep -E "mark=[4-7]" | head -20 || echo "No marked connections"
          echo ""
          echo "=== All UDP conntrack entries (sample) ==="
          sudo conntrack -L -p udp 2>/dev/null | head -10 || true

      - name: Show BPF map dump
        if: always()
        run: |
          # Stop proxy gracefully to trigger map dump
          sudo ${{ env.EGRESS_FILTER_ROOT || '/home/runner/work/_actions/gregclermont/egress-filter/test' }}/src/setup/proxy.sh stop || true
          cat /tmp/bpf_map_dump.txt || echo "No BPF map dump found"
          echo ""
          echo "=== Proxy shutdown log ==="
          tail -5 /tmp/proxy.log 2>/dev/null || true
