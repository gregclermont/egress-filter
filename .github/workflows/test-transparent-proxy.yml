name: Test transparent proxy

on:
  workflow_dispatch:
    inputs:
      verbose:
        description: 'Enable verbose test output'
        type: boolean
        default: false

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  test:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Setup egress filter
        uses: gregclermont/egress-filter@main
        env:
          VERBOSE: ${{ inputs.verbose && '1' || '0' }}

      - uses: actions/checkout@v6
        with:
          sparse-checkout: tests
          fetch-depth: 1

      - name: Run PID tracking tests
        run: ./tests/test_pid_tracking.sh
        env:
          PROXY_LOG_FILE: /tmp/proxy.log
          VERBOSE: ${{ inputs.verbose && '1' || '0' }}

      - name: Show proxy logs
        if: always()
        env:
          VERBOSE: ${{ inputs.verbose && '1' || '0' }}
        run: |
          echo "=== Proxy Log ==="
          cat /tmp/proxy.log || echo "No log file found"
          if [ "$VERBOSE" = "1" ] && [ -f /tmp/mitmproxy.log ]; then
            echo ""
            echo "=== Mitmproxy Log (verbose) ==="
            cat /tmp/mitmproxy.log
          fi
