name: Test mitmproxy WireGuard (simple)

on:
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup and test mitmproxy wireguard
        run: |
          set -ex

          log() {
            echo "[$(date +%H:%M:%S.%3N)] $*"
          }

          log "Starting"

          # Install deps
          log "Installing wireguard-tools..."
          sudo apt-get update
          sudo apt-get install -y wireguard-tools
          log "✓ wireguard-tools installed"

          log "Installing mitmproxy..."
          sudo pip install mitmproxy --break-system-packages --ignore-installed
          log "✓ mitmproxy installed"

          # Verify it's accessible system-wide
          which mitmdump
          sudo -u nobody mitmdump --version
          log "✓ mitmproxy accessible system-wide"

          # Create mitmproxy user with home dir
          sudo useradd -r -m mitmproxy
          log "✓ Created user"

          # Setup routing bypass for mitmproxy user
          sudo iptables -t mangle -A OUTPUT -m owner --uid-owner mitmproxy -j MARK --set-mark 0x1
          sudo ip rule add fwmark 0x1 lookup main priority 100
          log "✓ Routing bypass configured"

          # Verify mitmproxy user can reach internet
          sudo -u mitmproxy curl -sI https://example.com | head -1
          log "✓ mitmproxy user can reach internet"

          # Start mitmproxy
          log "Starting mitmproxy..."
          sudo -u mitmproxy bash -c 'mitmdump --mode wireguard --set block_global=false > /tmp/mitm.log 2>&1' &
          MITM_PID=$!
          log "✓ Started mitmproxy (PID: $MITM_PID)"
          sleep 2

          # Check if process is still running
          if ps -p $MITM_PID > /dev/null 2>&1; then
            log "✓ mitmproxy process is running"
          else
            log "✗ mitmproxy process exited early!"
            cat /tmp/mitm.log || echo "No log file"
            exit 1
          fi

          # Wait for WireGuard config to appear
          log "Waiting for WireGuard config..."
          for i in {1..30}; do
            if grep -q "\[Interface\]" /tmp/mitm.log; then
              log "✓ WireGuard config appeared (attempt $i)"
              break
            fi
            # Show progress every 5 seconds
            if [ $((i % 5)) -eq 0 ]; then
              log "Still waiting... ($i/30)"
              wc -l /tmp/mitm.log || true
              tail -5 /tmp/mitm.log || true
            fi
            sleep 1
          done

          echo "=== mitmproxy output ==="
          cat /tmp/mitm.log
          echo "========================"

          # Extract config
          log "Extracting config..."
          sed -n '/\[Interface\]/,/^---/p' /tmp/mitm.log | grep -v '^---' > /tmp/wg.conf
          cat /tmp/wg.conf
          log "✓ Config extracted"

          # Bring up wireguard
          log "Bringing up wg0..."
          sudo cp /tmp/wg.conf /etc/wireguard/wg0.conf
          sudo wg-quick up wg0
          log "✓ WireGuard interface up"

          sudo wg show

          # Test
          log "Testing connectivity..."
          curl -v --max-time 10 https://example.com 2>&1 | head -20
          log "✓ curl completed"

          echo "=== mitmproxy logs ==="
          cat /tmp/mitm.log
          log "Done"
