name: Test mitmproxy transparent

on:
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  test:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v4

      - name: Install system dependencies
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y -qq libbpf-dev

      - name: Install dependencies
        run: uv sync

      - name: Compile BPF programs
        run: uv run tinybpf docker-compile src/bpf/*.bpf.c

      - name: Setup mitmproxy transparent mode with BPF tracking
        run: |
          set -e

          # Cleanup iptables on failure to avoid breaking runner communication
          cleanup() {
            sudo iptables -t nat -F 2>/dev/null || true
            sudo ip6tables -t nat -F 2>/dev/null || true
          }
          trap cleanup ERR

          # Start proxy as root (needed for BPF), exclude root's traffic via iptables
          echo "Starting proxy..."
          sudo env PROXY_LOG_FILE=/tmp/proxy.log \
            $(pwd)/.venv/bin/python proxy.py > /tmp/proxy-stdout.log 2>&1 &
          PROXY_PID=$!

          # Wait for proxy to be listening
          counter=0
          while ! sudo ss -tln | grep -q ':8080 '; do
            sleep 1
            counter=$((counter+1))
            if ! sudo kill -0 $PROXY_PID 2>/dev/null; then
              echo "Proxy process died! Output:"
              cat /tmp/proxy-stdout.log || true
              exit 1
            fi
            if [ $counter -gt 10 ]; then
              echo "Timeout waiting for proxy"
              exit 1
            fi
          done
          echo "Proxy listening on port 8080"

          # Debug: find where mitmproxy put the cert
          echo "Looking for mitmproxy certs..."
          sudo find /root /home -name "mitmproxy-ca-cert.pem" 2>/dev/null || true
          sudo ls -la /root/.mitmproxy/ 2>/dev/null || echo "No /root/.mitmproxy/"
          sudo ls -la ~/.mitmproxy/ 2>/dev/null || echo "No ~/.mitmproxy/"

          # Setup iptables - exclude root's traffic to prevent loops
          sudo sysctl -w net.ipv4.ip_forward=1
          sudo sysctl -w net.ipv6.conf.all.forwarding=1
          sudo sysctl -w net.ipv4.conf.all.send_redirects=0
          sudo iptables -t nat -A OUTPUT -p tcp -m owner --uid-owner 0 -j RETURN
          sudo iptables -t nat -A OUTPUT -p tcp -j REDIRECT --to-port 8080
          sudo ip6tables -t nat -A OUTPUT -p tcp -m owner --uid-owner 0 -j RETURN
          sudo ip6tables -t nat -A OUTPUT -p tcp -j REDIRECT --to-port 8080

          # Find and install mitmproxy certificate as system CA
          CERT_PATH=$(sudo find /root /home -name "mitmproxy-ca-cert.pem" 2>/dev/null | head -1)
          if [ -z "$CERT_PATH" ]; then
            echo "ERROR: Could not find mitmproxy CA certificate"
            exit 1
          fi
          echo "Found certificate at: $CERT_PATH"

          sudo mkdir -p /usr/local/share/ca-certificates/extra
          sudo openssl x509 -in "$CERT_PATH" -inform PEM -out /tmp/mitmproxy-ca-cert.crt
          sudo cp /tmp/mitmproxy-ca-cert.crt /usr/local/share/ca-certificates/extra/mitmproxy-ca-cert.crt
          sudo dpkg-reconfigure -p critical ca-certificates
          sudo update-ca-certificates

          # Set CA env vars for tools that don't use system store
          echo "NODE_EXTRA_CA_CERTS=$CERT_PATH" >> $GITHUB_ENV
          echo "REQUESTS_CA_BUNDLE=$CERT_PATH" >> $GITHUB_ENV

          echo "--all done--"

      - name: Test connectivity through proxy
        run: |
          # Run tests as non-root user so traffic goes through proxy
          echo "Testing HTTP..."
          curl -v http://example.com 2>&1 | head -20

          echo "Testing HTTPS..."
          curl -v https://example.com 2>&1 | head -20

          echo "Testing with wget..."
          wget -O /dev/null https://httpbin.org/get

          echo "Testing non-HTTP TCP (SSH to github.com)..."
          echo "" | nc -v github.com 22 2>&1 | head -5 || true

          echo "All tests passed!"

      - name: Show proxy logs
        if: always()
        run: |
          echo "=== Proxy Log (custom) ==="
          cat /tmp/proxy.log || echo "No log file found"
          echo ""
          echo "=== Proxy stdout/stderr ==="
          cat /tmp/proxy-stdout.log || echo "No log file found"
          echo ""
          echo "=== Mitmproxy Log (debug) ==="
          cat /tmp/mitmproxy.log || echo "No log file found"

      - name: Upload proxy logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: proxy-logs
          path: |
            /tmp/proxy.log
            /tmp/proxy-stdout.log
            /tmp/mitmproxy.log
          if-no-files-found: warn
