name: Test mitmproxy transparent

on:
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  test:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - uses: actions/checkout@v4

      - name: Setup mitmproxy transparent mode
        run: |
          set -e

          # Cleanup iptables on failure to avoid breaking runner communication
          cleanup() {
            sudo iptables -t nat -F 2>/dev/null || true
            sudo ip6tables -t nat -F 2>/dev/null || true
          }
          trap cleanup ERR

          # Create mitmproxyuser - proxy won't intercept local traffic from same user
          sudo useradd mitmproxyuser
          sudo mkdir -p /home/mitmproxyuser/.local/bin
          sudo chown -R mitmproxyuser:mitmproxyuser /home/mitmproxyuser

          # Install uv (UV_UNMANAGED_INSTALL skips receipt file for CI)
          sudo -u mitmproxyuser -H bash -e -c 'curl -LsSf https://astral.sh/uv/install.sh | UV_UNMANAGED_INSTALL=/home/mitmproxyuser/.local/bin sh'

          # Copy proxy script and config
          sudo cp proxy.py config.json /home/mitmproxyuser/
          sudo chown mitmproxyuser:mitmproxyuser /home/mitmproxyuser/config.json
          sudo chmod 600 /home/mitmproxyuser/config.json

          # Start proxy in background (--python 3.12 ensures compatible version)
          sudo -i -u mitmproxyuser PROXY_LOG_FILE=/tmp/proxy.log /home/mitmproxyuser/.local/bin/uv run --python 3.12 /home/mitmproxyuser/proxy.py &

          # Wait for proxy to generate CA certificate (before iptables to avoid breaking runner comms)
          # Allow up to 60s for uv to download python + mitmproxy + start
          counter=0
          while [ ! -f /home/mitmproxyuser/.mitmproxy/mitmproxy-ca-cert.pem ]; do
            sleep 1
            counter=$((counter+1))
            if [ $counter -gt 60 ]; then
              echo "Timeout waiting for certificate"
              exit 1
            fi
            if [ $((counter % 10)) -eq 0 ]; then
              echo "Waiting for mitmproxy to start... ($counter/60)"
            fi
          done

          # Setup iptables now that proxy is confirmed running
          sudo sysctl -w net.ipv4.ip_forward=1
          sudo sysctl -w net.ipv6.conf.all.forwarding=1
          sudo sysctl -w net.ipv4.conf.all.send_redirects=0
          sudo iptables -t nat -A OUTPUT -p tcp -m owner ! --uid-owner mitmproxyuser --dport 80 -j REDIRECT --to-port 8080
          sudo iptables -t nat -A OUTPUT -p tcp -m owner ! --uid-owner mitmproxyuser --dport 443 -j REDIRECT --to-port 8080
          sudo iptables -t nat -A OUTPUT -p tcp -m owner ! --uid-owner mitmproxyuser --dport 22 -j REDIRECT --to-port 8080
          sudo ip6tables -t nat -A OUTPUT -p tcp -m owner ! --uid-owner mitmproxyuser --dport 80 -j REDIRECT --to-port 8080
          sudo ip6tables -t nat -A OUTPUT -p tcp -m owner ! --uid-owner mitmproxyuser --dport 443 -j REDIRECT --to-port 8080
          sudo ip6tables -t nat -A OUTPUT -p tcp -m owner ! --uid-owner mitmproxyuser --dport 22 -j REDIRECT --to-port 8080

          # Install mitmproxy certificate as system CA
          sudo mkdir -p /usr/local/share/ca-certificates/extra
          sudo openssl x509 -in /home/mitmproxyuser/.mitmproxy/mitmproxy-ca-cert.pem -inform PEM -out ~/mitmproxy-ca-cert.crt
          sudo cp ~/mitmproxy-ca-cert.crt /usr/local/share/ca-certificates/extra/mitmproxy-ca-cert.crt
          sudo dpkg-reconfigure -p critical ca-certificates
          sudo update-ca-certificates

          # Set CA env vars for tools that don't use system store
          echo "NODE_EXTRA_CA_CERTS=/home/mitmproxyuser/.mitmproxy/mitmproxy-ca-cert.pem" >> $GITHUB_ENV
          echo "REQUESTS_CA_BUNDLE=/home/mitmproxyuser/.mitmproxy/mitmproxy-ca-cert.pem" >> $GITHUB_ENV
          echo "HEX_CACERTS_PATH=/home/mitmproxyuser/.mitmproxy/mitmproxy-ca-cert.pem" >> $GITHUB_ENV
          echo "AWS_CA_BUNDLE=/home/mitmproxyuser/.mitmproxy/mitmproxy-ca-cert.pem" >> $GITHUB_ENV

          echo "--all done--"

      - name: Test connectivity through proxy
        run: |
          echo "Testing HTTP..."
          curl -v http://example.com 2>&1 | head -20

          echo "Testing HTTPS..."
          curl -v https://example.com 2>&1 | head -20

          echo "Testing with wget..."
          wget -O /dev/null https://httpbin.org/get

          echo "Testing non-HTTP TCP (SSH to github.com)..."
          nc -zv github.com 22 2>&1

          echo "All tests passed!"

      - name: Show proxy logs
        if: always()
        run: |
          echo "=== Proxy Log (custom) ==="
          cat /tmp/proxy.log || echo "No log file found"
          echo ""
          echo "=== Mitmproxy Log (debug) ==="
          cat /tmp/mitmproxy.log || echo "No log file found"

      - name: Upload proxy logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: proxy-logs
          path: |
            /tmp/proxy.log
            /tmp/mitmproxy.log
          if-no-files-found: warn
