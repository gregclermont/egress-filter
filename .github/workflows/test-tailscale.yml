name: Test Tailscale Compatibility

on:
  workflow_dispatch:
  push:
    branches: [test]

jobs:
  test-tailscale:
    runs-on: ubuntu-latest
    steps:
      - name: Start egress filter
        uses: gregclermont/egress-filter@test
        with:
          allow-sudo: true  # Tailscale action needs sudo to install
          policy: |
            [action=tailscale/github-action]
            pkgs.tailscale.com
            dl.tailscale.com
            api.tailscale.com

            [exe=/usr/local/bin/tailscaled]
            *.tailscale.com
            0.0.0.0/0:443|80
            0.0.0.0/0:*/udp

      - name: Connect to Tailscale
        uses: tailscale/github-action@v4
        with:
          oauth-client-id: ${{ secrets.TAILSCALE_OAUTH_CLIENT_ID }}
          oauth-secret: ${{ secrets.TAILSCALE_OAUTH_SECRET }}
          tags: tag:github-actions

      - name: Disable sudo after setup
        uses: gregclermont/egress-filter/disable-sudo@test

      - name: Verify sudo is disabled
        run: |
          if sudo -n true 2>/dev/null; then
            echo "::error::Sudo should be disabled but it's not!"
            exit 1
          fi
          echo "✓ Sudo is disabled as expected"

      - name: Re-enable sudo
        uses: gregclermont/egress-filter/enable-sudo@test

      - name: Verify sudo is re-enabled
        run: |
          if ! sudo -n true 2>/dev/null; then
            echo "::error::Sudo should be enabled but it's not!"
            exit 1
          fi
          echo "✓ Sudo is re-enabled as expected"

      - name: Test connectivity to test node
        run: |
          echo "=== Tailscale status ==="
          tailscale status

          echo ""
          echo "=== Ping test node ==="
          # tailscale ping exits 1 if no direct connection, but DERP relay is fine for our test
          tailscale ping --c 3 lima-tinybpf || echo "(direct connection not established, but DERP relay works)"

      - name: Show proxy logs
        if: always()
        run: cat /tmp/proxy.log 2>/dev/null | tail -100 || echo "No proxy.log"

  # Test that sudo is disabled by default (no allow-sudo)
  test-default-sudo-disabled:
    runs-on: ubuntu-latest
    steps:
      - name: "Start egress filter (default: sudo disabled)"
        uses: gregclermont/egress-filter@test
        with:
          policy: |
            # Empty policy, just testing sudo behavior

      - name: Verify sudo is disabled by default
        run: |
          if sudo -n true 2>/dev/null; then
            echo "::error::Sudo should be disabled by default but it's not!"
            exit 1
          fi
          echo "✓ Sudo is disabled by default as expected"

      - name: Check egress filter logs
        if: always()
        run: |
          echo "=== Proxy log ==="
          cat /tmp/proxy.log 2>/dev/null | tail -50 || echo "No proxy.log"
